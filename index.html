<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GTA-RP Triage/Consult ‚Äî Outil EMS</title>
  <style>
    :root {
      --bg: #0f172a; /* slate-900 */
      --card: #111827; /* gray-900 */
      --text: #e2e8f0; /* slate-200 */
      --muted: #94a3b8; /* slate-400 */
      --accent: #6366f1; /* indigo-500 */
      --accent-2: #22c55e; /* green-500 */
      --warn: #f59e0b; /* amber-500 */
      --danger: #ef4444; /* red-500 */
      --border: #1f2937; /* gray-800 */
      --chip: #0f172a; /* slate-900 */
      --overlay: rgba(15, 23, 42, 0.85);

      --radius-lg: 12px;
      --radius-md: 8px;
    }
    * { box-sizing: border-box; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: var(--bg);
      color: var(--text);
    }
    .container { max-width: 1024px; margin: 40px auto; padding: 0 16px; }
    header { display:flex; flex-wrap:wrap; align-items:center; justify-content:space-between; gap:16px; margin-bottom:16px; }
    .brand { display:flex; align-items:center; gap:12px; }
    .logo { width:40px; height:40px; border-radius:var(--radius-md); background: linear-gradient(135deg, var(--accent), #8b5cf6); box-shadow: 0 10px 25px rgba(99,102,241,.35); }
    h1 { font-size: clamp(22px, 3vw, 26px); margin:0; letter-spacing: .2px; }
    .card {
      background: var(--card);
      border:1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 24px;
      box-shadow: 0 4px 12px rgba(0,0,0,.25);
    }
    .grid {
      display:grid;
      grid-template-columns: 1fr;
      gap: 24px;
    }
    @media (min-width: 900px) {
      .grid { grid-template-columns: 1.2fr 0.8fr; }
    }
    label { font-size: 14px; color: var(--muted); display:block; margin-bottom:6px; }
    textarea, select, input[type="text"], input[type="number"] {
      width:100%;
      background: var(--bg);
      color:var(--text);
      border:1px solid var(--border);
      padding:10px 12px;
      border-radius: var(--radius-md);
      outline:none;
      font-size:15px;
    }
    textarea:focus, select:focus, input[type="text"]:focus, input[type="number"]:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(99,102,241,.25);
    }
    .range-wrap {
      background: var(--bg);
      border:1px solid var(--border);
      padding:12px;
      border-radius: var(--radius-md);
    }
    input[type="range"] { width:100%; }
    .row { display:flex; flex-wrap:wrap; gap:16px; }
    .chip {
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 12px;
      border-radius: var(--radius-md);
      background: var(--chip);
      border:1px solid var(--border);
      font-size: 14px;
      cursor:pointer;
      user-select:none;
    }
    .chip input { width:auto; margin-right:4px; }
    .btns { display:flex; gap:10px; flex-wrap:wrap; }
    .btn {
      background: var(--accent);
      color:white;
      border:none;
      padding: 10px 16px;
      border-radius: var(--radius-md);
      cursor:pointer;
      font-weight:600;
      letter-spacing:.2px;
      font-size:15px;
    }
    .btn.secondary { background:transparent; border:1px solid #334155; color: var(--text); }
    .btn.ghost { background:transparent; color: var(--muted); padding: 8px 10px; }
    .btn:disabled { opacity:.5; cursor:not-allowed; }
    .section-title { font-size:18px; font-weight:700; margin: 0 0 12px; }
    .results { display:grid; gap:12px; }
    .result {
      border:1px solid var(--border);
      border-left:4px solid var(--accent);
      padding:12px;
      border-radius: var(--radius-md);
      background: var(--bg);
    }
    .prio { font-size:12px; color:#cbd5e1; opacity:.9; }
    .tag { font-weight:700; }
    .advice { color:#cbd5e1; margin-top:4px; }
    .callout {
      border:1px solid rgba(245, 158, 11, .35);
      color:#fde68a;
      border-radius: var(--radius-md);
      padding:10px 12px;
      font-size:14px;
      background: rgba(245, 158, 11, .1);
    }
    .triage-p1 { background: rgba(239, 68, 68, .2); border-color: rgba(239, 68, 68, .4); color: #fca5a5; }
    .triage-p2 { background: rgba(245, 158, 11, .1); border-color: rgba(245, 158, 11, .35); color:#fde68a; }
    .triage-p3 { background: rgba(34, 197, 94, .1); border-color: rgba(34, 197, 94, .3); color: #86efac; }
    .triage-p4 { background: rgba(148, 163, 184, .1); border-color: rgba(148, 163, 184, .3); color: #cbd5e1; }
    footer { margin-top: 24px; color: #94a3b8; font-size: 12px; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; background:#0b1220; border:1px solid #1f2937; padding:2px 6px; border-radius:6px; }
    .titlebar { display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:16px; }
    .pill {
      font-size:12px;
      padding: 4px 10px;
      border:1px solid #334155;
      border-radius:999px;
      color:#a5b4fc;
      background: rgba(99,102,241,.08);
    }
    .success { border-left-color: var(--accent-2); }
    .danger { border-left-color: var(--danger); }
    .tabs { display:flex; gap:10px; margin-bottom:16px; }
    .timers { background:transparent; border:none; box-shadow:none; padding:0; }
    .timer-display { font-size:24px; font-family: ui-monospace, monospace; color:var(--text); font-weight:600; margin-bottom:8px; }

    /* === Body-map === */
    .bodymap { display:flex; align-items:center; gap:12px; margin-top:8px; }
    .bodymap .mapwrap {
      background: var(--bg);
      border:1px solid var(--border);
      border-radius: var(--radius-md);
      padding:10px; width:260px; min-width:260px;
    }
    .bodymap-hint { font-size:12px; color:var(--muted); }
    .bm-region {
      fill:#0b1220; stroke:#263043; stroke-width:1.5; cursor:pointer;
      transition:fill .15s ease, stroke .15s ease;
    }
    .bm-region:hover, .bm-region:focus { outline:none; fill:#111a2e; stroke:#7c89ff; }
    .bm-region.active { fill:rgba(99,102,241,.28); stroke:#8b5cf6; }

    /* === Vitals Cliquables === */
    .vitals-grid label {
      cursor: pointer;
      text-decoration: underline dashed 1px var(--muted);
      user-select: none;
    }
    .vitals-grid label:hover {
      color: var(--text);
    }

    /* === Journal Modal === */
    .modal-overlay {
      display: none; position: fixed; z-index: 100;
      left:0; top:0; width:100%; height:100%;
      background: var(--overlay); backdrop-filter: blur(5px);
      padding: 20px;
    }
    .modal-content {
      position: relative; max-width: 700px; margin: 5vh auto;
      max-height: 90vh; overflow-y: auto;
    }
    .journal-entry {
      border:1px solid var(--border);
      border-radius: var(--radius-md);
      background: var(--bg);
      padding: 10px; margin-bottom: 8px; font-size: 14px;
    }
    .journal-entry div { margin-bottom: 4px; }
    .btn-journal-load { font-size: 12px; padding: 6px 8px; margin-top: 5px; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Outil EMS ‚Äî <strong>Triage & Consultation</strong></h1>
          <div class="pill" aria-live="polite">Ne remplace pas un avis m√©dical pouss√© √† l'hopital</div>
        </div>
      </div>
      <div class="row">
        <button class="btn ghost" id="btn-start" title="M√©moriser l'heure de d√©but">üïí D√©but inter.</button>
        <span class="pill" id="start-pill" aria-live="polite">D√©but: ‚Äî</span>
        <button class="btn ghost" id="btn-journal">Journal de Bord</button>
        <button class="btn ghost" id="btn-print" title="Imprimer / PDF">Imprimer</button>
      </div>
    </header>

    <section class="card timers" style="margin-bottom:16px;">
      <div class="row" style="justify-content: space-around; gap: 20px;">
        <div>
          <label>Chronom√®tre</label>
          <div class="timer-display" id="chrono-display">00:00</div>
          <div class="btns">
            <button class="btn ghost" id="btn-chrono-start">‚ñ∂</button>
            <button class="btn ghost" id="btn-chrono-stop" disabled>‚ùö‚ùö</button>
            <button class="btn ghost" id="btn-chrono-reset">Reset</button>
          </div>
        </div>
        <div>
          <label>Minuteur (ex. RCP)</label>
          <div class="timer-display" id="countdown-display">00:00</div>
          <div class="btns">
            <input type="number" id="countdown-input" value="2" style="width: 70px; padding: 8px;" title="Minutes" />
            <button class="btn ghost" id="btn-countdown-start">‚ñ∂</button>
            <button class="btn ghost" id="btn-countdown-stop" disabled>‚ùö‚ùö</button>
            <button class="btn ghost" id="btn-countdown-reset">Reset</button>
          </div>
        </div>
      </div>
    </section>

    <div class="tabs">
      <button class="btn" id="btn-tab-trauma" aria-pressed="true">Mode Trauma</button>
      <button class="btn secondary" id="btn-tab-consult" aria-pressed="false">Mode Consultation</button>
    </div>

    <div class="grid">
      <div>
        <section class="card" id="form-trauma" aria-labelledby="form-title-trauma">
          <div class="titlebar">
            <div class="section-title" id="form-title-trauma">Entr√©e patient RP (Trauma)</div>
          </div>
          
          <div class="row" style="gap:16px; margin-bottom:16px;">
             <div style="flex:1 1 180px; min-width:180px;">
                <label for="patient-name">Nom/ID Patient</label>
                <input type="text" id="patient-name" placeholder="ex. John Doe">
             </div>
             <div style="flex:1 1 120px; min-width:120px;">
                <label for="age">√Çge</label>
                <input type="text" id="age" placeholder="ex. 28">
             </div>
             <div style="flex:1 1 160px; min-width:160px;">
                <label for="delay">D√©lai depuis incident (h)</label>
                <input type="text" id="delay" placeholder="ex. 3">
             </div>
          </div>

          <div style="margin-bottom: 16px;">
            <label for="incident">Que s'est-il pass√© ? (r√©sum√© court)</label>
            <textarea id="incident" rows="3" placeholder="Ex.: √©change de tirs, impact cuisse G; saignement contr√¥l√©"></textarea>
          </div>

          <div class="row" style="gap:16px;">
            <div style="flex: 1.1; min-width: 280px;">
              <label for="location-display">Localisation(s) de la douleur</label>
              <div class="bodymap" aria-label="Carte du corps cliquable">
                <div class="mapwrap">
                  <svg id="bodymap-front" viewBox="0 0 200 360" width="100%" role="img" aria-labelledby="bmTitleF">
                    <title id="bmTitleF">Body-map mannequin (face)</title>
                    <g class="bm-regions">
                      <circle class="bm-region" tabindex="0" data-zone="tete" cx="100" cy="38" r="22"><title>T√™te / Cr√¢ne</title></circle>
                      <rect class="bm-region" tabindex="0" data-zone="cou" x="90" y="60" rx="4" ry="4" width="20" height="14"><title>Cou / Gorge</title></rect>
                      <rect class="bm-region" tabindex="0" data-zone="thorax" x="65" y="78" rx="10" ry="10" width="70" height="50"><title>Thorax / Poitrine</title></rect>
                      <rect class="bm-region" tabindex="0" data-zone="abdomen" x="70" y="132" rx="10" ry="10" width="60" height="36"><title>Abdomen / Ventre</title></rect>
                      <rect class="bm-region" tabindex="0" data-zone="bassin" x="72" y="172" rx="10" ry="10" width="56" height="28"><title>Bassin</title></rect>
                      <rect class="bm-region" tabindex="0" data-zone="bras_g" x="38" y="82" rx="12" ry="12" width="22" height="40"><title>Bras gauche (haut)</title></rect>
                      <rect class="bm-region" tabindex="0" data-zone="avant_bras_g" x="38" y="124" rx="12" ry="12" width="22" height="80"><title>Avant-bras gauche</title></rect>
                      <rect class="bm-region" tabindex="0" data-zone="bras_d" x="140" y="82" rx="12" ry="12" width="22" height="40"><title>Bras droit (haut)</title></rect>
                      <rect class="bm-region" tabindex="0" data-zone="avant_bras_d" x="140" y="124" rx="12" ry="12" width="22" height="80"><title>Avant-bras droit</title></rect>
                      <rect class="bm-region" tabindex="0" data-zone="cuisse_g" x="78" y="204" rx="10" ry="10" width="20" height="68"><title>Cuisse gauche</title></rect>
                      <rect class="bm-region" tabindex="0" data-zone="jambe_g" x="78" y="274" rx="10" ry="10" width="20" height="70"><title>Jambe gauche</title></rect>
                      <rect class="bm-region" tabindex="0" data-zone="cuisse_d" x="102" y="204" rx="10" ry="10" width="20" height="68"><title>Cuisse droite</title></rect>
                      <rect class="bm-region" tabindex="0" data-zone="jambe_d" x="102" y="274" rx="10" ry="10" width="20" height="70"><title>Jambe droite</title></rect>
                    </g>
                  </svg>
                  <svg id="bodymap-back" viewBox="0 0 200 360" width="100%" role="img" aria-labelledby="bmTitleB" style="display:none;">
                    <title id="bmTitleB">Body-map mannequin (dos)</title>
                    <g class="bm-regions">
                      <circle class="bm-region" tabindex="0" data-zone="tete_arriere" cx="100" cy="38" r="22"><title>Arri√®re de la t√™te</title></circle>
                      <rect class="bm-region" tabindex="0" data-zone="nuque" x="90" y="60" rx="4" ry="4" width="20" height="14"><title>Nuque</title></rect>
                      <rect class="bm-region" tabindex="0" data-zone="dos_haut" x="65" y="78" rx="10" ry="10" width="70" height="50"><title>Haut du dos (Dorsales)</title></rect>
                      <rect class="bm-region" tabindex="0" data-zone="lombaires" x="70" y="132" rx="10" ry="10" width="60" height="36"><title>Bas du dos (Lombaires)</title></rect>
                      <rect class="bm-region" tabindex="0" data-zone="fesses" x="72" y="172" rx="10" ry="10" width="56" height="28"><title>Fesses</title></rect>
                      <rect class="bm-region" tabindex="0" data-zone="arriere_bras_g" x="38" y="82" rx="12" ry="12" width="22" height="40"><title>Arri√®re bras gauche</title></rect>
                      <rect class="bm-region" tabindex="0" data-zone="arriere_avant_bras_g" x="38" y="124" rx="12" ry="12" width="22" height="80"><title>Arri√®re avant-bras G</title></rect>
                      <rect class="bm-region" tabindex="0" data-zone="arriere_bras_d" x="140" y="82" rx="12" ry="12" width="22" height="40"><title>Arri√®re bras droit</title></rect>
                      <rect class="bm-region" tabindex="0" data-zone="arriere_avant_bras_d" x="140" y="124" rx="12" ry="12" width="22" height="80"><title>Arri√®re avant-bras D</title></rect>
                      <rect class="bm-region" tabindex="0" data-zone="arriere_cuisse_g" x="78" y="204" rx="10" ry="10" width="20" height="68"><title>Arri√®re cuisse gauche</title></rect>
                      <rect class="bm-region" tabindex="0" data-zone="arriere_jambe_g" x="78" y="274" rx="10" ry="10" width="20" height="70"><title>Mollet gauche</title></rect>
                      <rect class="bm-region" tabindex="0" data-zone="arriere_cuisse_d" x="102" y="204" rx="10" ry="10" width="20" height="68"><title>Arri√®re cuisse droite</title></rect>
                      <rect class="bm-region" tabindex="0" data-zone="arriere_jambe_d" x="102" y="274" rx="10" ry="10" width="20" height="70"><title>Mollet droit</title></rect>
                    </g>
                  </svg>
                  <div class="bodymap-hint">Cliquez sur une ou plusieurs zones.</div>
                  <button class="btn secondary" id="btn-flip-map" style="width:100%; margin-top:8px;">üîÑ Retourner</button>
                </div>

                <div style="flex:1">
                  <input type="text" id="location-display" readonly placeholder="Cliquer sur le mannequin...">
                </div>
              </div>
            </div>

            <div style="flex: 0.9; min-width: 240px;">
              <label for="pain">Niveau de douleur (1‚Äì10)</label>
              <div class="range-wrap">
                <input id="pain" type="range" min="1" max="10" value="5" step="1" />
                <div style="display:flex; justify-content:space-between; margin-top:6px; font-size:12px; color:var(--muted)">
                  <span>1</span><span>5</span><span>10</span>
                </div>
                <div id="pain-label" style="margin-top:6px; font-weight:600;">S√©v√©rit√©: 5 ‚Äî Mod√©r√©e</div>
              </div>
            </div>
          </div>

          <div style="margin-top:16px">
            <label>ATCD (cocher si pr√©sents)</label>
            <div class="row">
              <label class="chip"><input type="checkbox" id="hx-anticoag" /> Anticoagulants</label>
              <label class="chip"><input type="checkbox" id="hx-diabetes" /> Diab√®te</label>
              <label class="chip"><input type="checkbox" id="hx-immuno" /> Immunod√©pression</label>
            </div>
          </div>

          <div style="margin-top:16px">
            <label>Signes visibles (cocher si pr√©sents)</label>
            <div class="row">
              <label class="chip"><input type="checkbox" id="f-bleeding" /> Saignement important</label>
              <label class="chip"><input type="checkbox" id="f-deformity" /> D√©formation</label>
              <label class="chip"><input type="checkbox" id="f-loc" /> Perte de conscience / confusion</label>
              <label class="chip"><input type="checkbox" id="f-gsw" /> Blessure par balle </label>
              <label class="chip"><input type="checkbox" id="f-burn" /> Br√ªlure</label>
            </div>
          </div>
        </section>

        <section class="card" id="form-consult" aria-labelledby="form-title-consult" style="display:none;">
          <div class="titlebar">
            <div class="section-title" id="form-title-consult">Entr√©e patient RP (Consultation)</div>
          </div>
          
          <div class="row" style="gap:16px; margin-bottom:16px;">
             <div style="flex:1 1 180px; min-width:180px;">
                <label for="patient-name-consult">Nom/ID Patient</label>
                <input type="text" id="patient-name-consult" placeholder="ex. John Doe">
             </div>
             <div style="flex:1 1 120px; min-width:120px;">
                <label for="age-consult">√Çge</label>
                <input type="text" id="age-consult" placeholder="ex. 28">
             </div>
          </div>

          <div class="section-title" style="font-size:16px; margin-top:10px;">Signes Vitaux (RP)</div>
          <div class="row vitals-grid" style="gap:12px;">
            <div style="flex:1 1 100px;">
              <label for="vital-fc">FC (bpm)</label>
              <input type="number" id="vital-fc" placeholder="ex. 75">
            </div>
            <div style="flex:1 1 100px;">
              <label for="vital-spo2">SpO2 (%)</label>
              <input type="number" id="vital-spo2" placeholder="ex. 98">
            </div>
            <div style="flex:1 1 100px;">
              <label for="vital-ta-sys">TA Sys</label>
              <input type="number" id="vital-ta-sys" placeholder="ex. 120">
            </div>
            <div style="flex:1 1 100px;">
              <label for="vital-ta-dia">TA Dia</label>
              <input type="number" id="vital-ta-dia" placeholder="ex. 80">
            </div>
            <div style="flex:1 1 100px;">
              <label for="vital-hgt">Glyc√©mie</label>
              <input type="number" id="vital-hgt" placeholder="ex. 90">
            </div>
            <div style="flex:1 1 100px;">
              <label for="vital-temp">Temp (¬∞C)</label>
              <input type="number" id="vital-temp" placeholder="ex. 37.0">
            </div>
          </div>

          <div class="section-title" style="font-size:16px; margin-top:16px;">Sympt√¥mes (cocher)</div>
          <div class="row">
            <label class="chip"><input type="checkbox" id="sym-chestpain" /> Douleur thoracique</label>
            <label class="chip"><input type="checkbox" id="sym-dyspnea" /> Difficult√© respi.</label>
            <label class="chip"><input type="checkbox" id="sym-fever" /> Fi√®vre / Frissons</label>
            <label class="chip"><input type="checkbox" id="sym-nausea" /> Naus√©es / Vomiss.</label>
            <label class="chip"><input type="checkbox" id="sym-dizzy" /> Vertiges / T√™te qui tourne</label>
            <label class="chip"><input type="checkbox" id="sym-confusion" /> Confusion / D√©sorient.</label>
            <label class="chip"><input type="checkbox" id="sym-abdo" /> Douleur abdominale</label>
            <label class="chip"><input type="checkbox" id="sym-headache" /> C√©phal√©e (mal de t√™te)</label>
          </div>
          
          <div style="margin-top:16px">
            <label for="consult-details">D√©tails compl√©mentaires</label>
            <textarea id="consult-details" rows="3" placeholder="Ex.: douleur thoracique oppressive irradiant bras gauche..."></textarea>
          </div>
        </section>

        <div class="btns" style="margin-top:16px;">
          <button class="btn" id="btn-calc">Calculer</button>
          <button class="btn secondary" id="btn-reset" type="button">R√©initialiser</button>
        </div>
      </div>

      <section class="card" aria-labelledby="res-title">
        <div class="titlebar">
          <div class="section-title" id="res-title">R√©sultats (pr√©-diagnostic)</div>
          <div class="prio" id="meta-count">‚Äî</div>
        </div>
        
        <div id="global-triage" class="callout" style="display: none; text-align: center; font-weight: bold; font-size: 1.1em; margin-bottom:12px;">
          </div>

        <div id="results" class="results" aria-live="polite"></div>
        <div id="no-results" class="callout" style="display:none; margin-top:8px">Aucun r√©sultat. Saisissez des informations puis cliquez <span class="kbd">Calculer</span>.</div>

        <button class="btn" id="btn-copy" style="margin-top:16px; width:100%">üìã Copier le r√©sum√©</button>
        <button class="btn ghost" id="btn-export-json" title="Exporter le cas (JSON)" style="width:100%; margin-top:8px;">Exporter (JSON)</button>
      </section>
    </div>

    <footer>
      <p>¬© <span id="year"></span> ‚Äî Triage/Consult Tool.</p>
    </footer>
  </div>

  <div id="journal-modal" class="modal-overlay">
    <div class="modal-content card">
      <div class="titlebar">
        <h2 class="section-title">Journal de Bord (20 derniers)</h2>
        <button class="btn ghost" id="btn-journal-close" style="font-size: 20px; padding: 0 8px;">&times;</button>
      </div>
      <div id="journal-content" style="max-height: 60vh; overflow-y: auto; padding-right: 10px;">
        </div>
      <button class="btn secondary" id="btn-journal-clear" style="margin-top: 15px;">Vider le journal</button>
    </div>
  </div>


  <script>
    // --- √âtat global ---
    let startAt = null; // Date object ou null
    let selectedZones = [];
    let chronoInterval = null;
    let chronoStartTime = 0;
    let chronoElapsedTime = 0;
    let countdownInterval = null;
    let countdownEndTime = 0;
    let countdownPaused = false;

    // --- Mappage des √âl√©ments (ELS) ---
    const els = {
      // Header
      btnStart: document.getElementById('btn-start'),
      startPill: document.getElementById('start-pill'),
      btnJournal: document.getElementById('btn-journal'),
      btnPrint: document.getElementById('btn-print'),
      // Timers
      chronoDisplay: document.getElementById('chrono-display'),
      btnChronoStart: document.getElementById('btn-chrono-start'),
      btnChronoStop: document.getElementById('btn-chrono-stop'),
      btnChronoReset: document.getElementById('btn-chrono-reset'),
      countdownDisplay: document.getElementById('countdown-display'),
      countdownInput: document.getElementById('countdown-input'),
      btnCountdownStart: document.getElementById('btn-countdown-start'),
      btnCountdownStop: document.getElementById('btn-countdown-stop'),
      btnCountdownReset: document.getElementById('btn-countdown-reset'),
      // Tabs
      btnTabTrauma: document.getElementById('btn-tab-trauma'),
      btnTabConsult: document.getElementById('btn-tab-consult'),
      formTrauma: document.getElementById('form-trauma'),
      formConsult: document.getElementById('form-consult'),
      // Formulaire Trauma
      patientName: document.getElementById('patient-name'),
      incident: document.getElementById('incident'),
      locationDisplay: document.getElementById('location-display'),
      pain: document.getElementById('pain'),
      painLabel: document.getElementById('pain-label'),
      age: document.getElementById('age'),
      delay: document.getElementById('delay'),
      hxAnticoag: document.getElementById('hx-anticoag'),
      hxDiabetes: document.getElementById('hx-diabetes'),
      hxImmuno: document.getElementById('hx-immuno'),
      fBleeding: document.getElementById('f-bleeding'),
      fDeformity: document.getElementById('f-deformity'),
      fLoc: document.getElementById('f-loc'),
      fGSW: document.getElementById('f-gsw'),
      fBurn: document.getElementById('f-burn'),
      btnFlipMap: document.getElementById('btn-flip-map'),
      bodyMapFront: document.getElementById('bodymap-front'),
      bodyMapBack: document.getElementById('bodymap-back'),
      // Formulaire Consultation
      patientNameConsult: document.getElementById('patient-name-consult'),
      ageConsult: document.getElementById('age-consult'),
      vitalFc: document.getElementById('vital-fc'),
      vitalSpo2: document.getElementById('vital-spo2'),
      vitalTaSys: document.getElementById('vital-ta-sys'),
      vitalTaDia: document.getElementById('vital-ta-dia'),
      vitalHgt: document.getElementById('vital-hgt'),
      vitalTemp: document.getElementById('vital-temp'),
      symChestpain: document.getElementById('sym-chestpain'),
      symDyspnea: document.getElementById('sym-dyspnea'),
      symFever: document.getElementById('sym-fever'),
      symNausea: document.getElementById('sym-nausea'),
      symDizzy: document.getElementById('sym-dizzy'),
      symConfusion: document.getElementById('sym-confusion'),
      symAbdo: document.getElementById('sym-abdo'),
      symHeadache: document.getElementById('sym-headache'),
      consultDetails: document.getElementById('consult-details'),
      // Boutons Formulaire
      btnCalc: document.getElementById('btn-calc'),
      btnReset: document.getElementById('btn-reset'),
      // R√©sultats
      globalTriage: document.getElementById('global-triage'),
      results: document.getElementById('results'),
      noResults: document.getElementById('no-results'),
      metaCount: document.getElementById('meta-count'),
      btnCopy: document.getElementById('btn-copy'),
      btnExport: document.getElementById('btn-export-json'),
      // Journal
      journalModal: document.getElementById('journal-modal'),
      journalContent: document.getElementById('journal-content'),
      btnJournalClose: document.getElementById('btn-journal-close'),
      btnJournalClear: document.getElementById('btn-journal-clear'),
      // Footer
      year: document.getElementById('year'),
    };

    // --- Heure d√©but intervention ---
    function fmtDateTime(dt) {
      return dt.toLocaleString(undefined, { year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' });
    }
    function setStartNow() {
      startAt = new Date();
      els.startPill.textContent = 'D√©but: ' + fmtDateTime(startAt);
      const old = els.btnStart.textContent;
      els.btnStart.textContent = '‚úÖ Heure enregistr√©e';
      setTimeout(()=> els.btnStart.textContent = old, 1200);
    }

    // --- Gestion des Tabs ---
    function setActiveTab(tabName) {
      if (tabName === 'trauma') {
        els.formTrauma.style.display = 'block';
        els.formConsult.style.display = 'none';
        els.btnTabTrauma.className = 'btn';
        els.btnTabTrauma.setAttribute('aria-pressed', 'true');
        els.btnTabConsult.className = 'btn secondary';
        els.btnTabConsult.setAttribute('aria-pressed', 'false');
      } else {
        els.formTrauma.style.display = 'none';
        els.formConsult.style.display = 'block';
        els.btnTabTrauma.className = 'btn secondary';
        els.btnTabTrauma.setAttribute('aria-pressed', 'false');
        els.btnTabConsult.className = 'btn';
        els.btnTabConsult.setAttribute('aria-pressed', 'true');
      }
      // Synchroniser le nom du patient entre les formulaires
      if (tabName === 'trauma') {
        els.patientNameConsult.value = els.patientName.value;
        els.ageConsult.value = els.age.value;
      } else {
        els.patientName.value = els.patientNameConsult.value;
        els.age.value = els.ageConsult.value;
      }
      clearResults();
    }
    // Synchronisation des champs communs
    els.patientName.addEventListener('input', () => els.patientNameConsult.value = els.patientName.value);
    els.patientNameConsult.addEventListener('input', () => els.patientName.value = els.patientNameConsult.value);
    els.age.addEventListener('input', () => els.ageConsult.value = els.age.value);
    els.ageConsult.addEventListener('input', () => els.age.value = els.age.value);


    // --- Body-map (Multi-select + Recto/Verso) ---
    const mapRegions = () => Array.from(document.querySelectorAll('.bm-region'));
    
    function toggleLocation(zone) {
      if (!zone) return;
      const regionEl = document.querySelector(`.bm-region[data-zone="${zone}"]`);
      if (selectedZones.includes(zone)) {
        selectedZones = selectedZones.filter(z => z !== zone);
        regionEl?.classList.remove('active');
      } else {
        selectedZones.push(zone);
        regionEl?.classList.add('active');
      }
      els.locationDisplay.value = selectedZones.join(', ') || 'Cliquer sur le mannequin...';
    }

    mapRegions().forEach(el=>{
      el.addEventListener('click', ()=> toggleLocation(el.dataset.zone));
      el.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' ') { e.preventDefault(); toggleLocation(el.dataset.zone);} });
    });

    els.btnFlipMap.addEventListener('click', () => {
      const isFront = els.bodyMapFront.style.display !== 'none';
      els.bodyMapFront.style.display = isFront ? 'none' : 'block';
      els.bodyMapBack.style.display = isFront ? 'block' : 'none';
    });

    // --- Douleur (Trauma) ---
    function updatePainLabel() {
      const v = Number(els.pain.value);
      const band = v <= 3 ? 'Faible' : v <= 7 ? 'Mod√©r√©e' : 'S√©v√®re';
      els.painLabel.textContent = `S√©v√©rit√©: ${v} ‚Äî ${band}`;
    }
    els.pain.addEventListener('input', updatePainLabel);

    // --- Timers ---
    function formatTimer(ms) {
      const totalSeconds = Math.floor(ms / 1000);
      const minutes = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
      const seconds = (totalSeconds % 60).toString().padStart(2, '0');
      return `${minutes}:${seconds}`;
    }

    // Chrono
    function startChrono() {
      if (chronoInterval) return;
      chronoStartTime = Date.now() - chronoElapsedTime;
      chronoInterval = setInterval(() => {
        chronoElapsedTime = Date.now() - chronoStartTime;
        els.chronoDisplay.textContent = formatTimer(chronoElapsedTime);
      }, 100);
      els.btnChronoStart.disabled = true;
      els.btnChronoStop.disabled = false;
    }
    function stopChrono() {
      clearInterval(chronoInterval);
      chronoInterval = null;
      els.btnChronoStart.disabled = false;
      els.btnChronoStop.disabled = true;
    }
    function resetChrono() {
      stopChrono();
      chronoElapsedTime = 0;
      els.chronoDisplay.textContent = '00:00';
    }

    // Countdown
    function startCountdown() {
      if (countdownInterval) { // Resume
        countdownEndTime = Date.now() + (countdownEndTime - Date.now());
        countdownPaused = false;
      } else { // Start new
        const minutes = parseFloat(els.countdownInput.value) || 0;
        if (minutes <= 0) return;
        countdownEndTime = Date.now() + minutes * 60000;
      }
      
      countdownInterval = setInterval(updateCountdown, 100);
      els.btnCountdownStart.disabled = true;
      els.btnCountdownStop.disabled = false;
      els.countdownInput.disabled = true;
    }
    function updateCountdown() {
      const remaining = countdownEndTime - Date.now();
      if (remaining <= 0) {
        stopCountdown();
        els.countdownDisplay.textContent = '00:00';
        els.countdownDisplay.style.color = 'var(--danger)';
        setTimeout(() => els.countdownDisplay.style.color = 'var(--text)', 2000);
      } else {
        els.countdownDisplay.textContent = formatTimer(remaining);
      }
    }
    function stopCountdown() {
      clearInterval(countdownInterval);
      countdownInterval = null;
      countdownPaused = true;
      els.btnCountdownStart.disabled = false;
      els.btnCountdownStop.disabled = true;
    }
    function resetCountdown() {
      stopCountdown();
      countdownPaused = false;
      els.countdownDisplay.textContent = '00:00';
      els.countdownDisplay.style.color = 'var(--text)';
      els.countdownInput.disabled = false;
    }

    // --- MOTEUR DE DIAGNOSTIC (TRAUMA) - REWORKED ---
    function computeTraumaDiagnosis({ locations, pain, findings, age, delayHours, hx }) {
      const out = [];
      const p = Number(pain);
      const uniqueTags = new Set();

      const addResult = (item) => {
        if (!uniqueTags.has(item.tag)) {
          out.push(item);
          uniqueTags.add(item.tag);
        }
      };

      // Red flags g√©n√©raux
      if (findings.bleeding) addResult({ tag: 'H√©morragie active', priority: 1, advice: 'Compression/garrot, bilan choc, √©vacuation rapide pour h√©mostase.' });
      if (findings.lossOfConsciousness) addResult({ tag: 'Traumatisme Cr√¢nien (TC) avec alt√©ration de conscience', priority: 1, advice: "Immobilisation rachis cervical, surveillance GCS, √©vacuation. Risque d'HED/HSD." });

      // GSW : toujours P1
      if (findings.gsw) {
        addResult({ tag: 'Blessure par balle (Multiples)', priority: 1, advice: "Urgence vitale : contr√¥le h√©morragie, pansement occlusif si thorax, √©vacuation imm√©diate pour chirurgie." });
      }
      
      // Br√ªlures
      if (findings.burn) {
        let burnAdvice = 'Refroidir, pansement st√©rile (type tulle gras), hydratation.';
        let burnPrio = 2;
        let burnTag = 'Br√ªlure 2√®me degr√© (possible)';
        if (locations.some(z => ['tete', 'cou', 'thorax', 'tete_arriere', 'nuque'].includes(z))) {
            burnAdvice = "Risque d'≈ìd√®me. Assise, O2 haut d√©bit. √âvacuation urgente pour fibroscopie/intubation.";
            burnPrio = 1;
            burnTag = "Br√ªlure VADS / L√©sion d'inhalation";
        }
        addResult({ tag: burnTag, priority: burnPrio, advice: burnAdvice });
      }
      
      // Helpers zones (UTILISANT LES ID FRAN√áAIS)
      const isHeadNeck = z => ['tete', 'cou', 'tete_arriere', 'nuque'].includes(z);
      const isChest = z => ['thorax', 'dos_haut'].includes(z);
      const isAbdoPelvis = z => ['abdomen', 'bassin', 'lombaires', 'fesses'].includes(z);
      const isUpperExt = z => z.includes('bras'); // Cible bras_g, avant_bras_g, arriere_bras_g, etc.
      const isLowerExt = z => z.includes('cuisse') || z.includes('jambe'); // Cible cuisse_g, jambe_g, etc.

      // √âvaluation par zone (pour chaque zone s√©lectionn√©e)
      for (const loc of locations) {
        
        // GSW par zone (plus sp√©cifique)
        if (findings.gsw) {
          if (isChest(loc)) addResult({ tag: 'GSW Thoracique (Pneumo/H√©mothorax Tendu suspect√©)', priority: 1, advice: 'Pansement occlusif 3 c√¥t√©s, O2. Pr√©parer exsufflation si d√©tresse. √âvacuation.' });
          else if (isAbdoPelvis(loc)) addResult({ tag: 'GSW Abdominal/Pelvien (L√©sion visc√©rale/vasculaire)', priority: 1, advice: 'Choc h√©morragique probable. Transport rapide vers bloc.' });
          else if (isHeadNeck(loc)) addResult({ tag: 'GSW T√™te/Cou (L√©sion c√©r√©brale/vasculaire critique)', priority: 1, advice: 'Saignement : prioriser contr√¥le, √©vacuation imm√©diate.' });
          else if (isUpperExt(loc) || isLowerExt(loc)) addResult({ tag: 'GSW Membre (L√©sion vasculo-nerveuse/Fracture ouverte)', priority: 1, advice: 'Garrot/pression, v√©rifier motricit√©/sensibilit√© distale, √©vacuation.' });
        }
        
        // Logique trauma standard
        if (isHeadNeck(loc)) {
          if (p >= 8) addResult({ tag: 'TC S√©v√®re (Fracture cr√¢ne / H√©morragie suspect√©e)', priority: 1, advice: 'Rachis cervical! Bilan neuro (GCS, pupilles). √âvacuation pour TDM c√©r√©bral.' });
          else if (p >= 4) addResult({ tag: 'TC L√©ger / Commotion c√©r√©brale', priority: 3, advice: 'Repos, surveillance neuro 24h. Si vomissements, confusion -> H√¥pital.' });
          
          if (loc === 'cou' || loc === 'nuque') {
            if (p >= 6 || findings.deformity) addResult({ tag: 'Entorse cervicale ("Coup du lapin") / L√©sion rachis', priority: 2, advice: 'Minerve (RP), plan dur. Bilan neuro. √âvacuation pour imagerie si signes ou douleur > 6.' });
          }
        }
        else if (isChest(loc)) {
          if (p >= 8 || findings.deformity) {
            addResult({ tag: 'Volet Costal / Fractures Costales Multiples', priority: 1, advice: 'Risque de d√©tresse respi (Respi paradoxale). O2, antalgiques. √âvacuation.' });
            addResult({ tag: 'Pneumothorax / H√©mothorax (post-trauma)', priority: 1, advice: 'Douleur + dyspn√©e. O2. √âvacuation pour drain thoracique.' });
          } else if (p >= 6) {
            addResult({ tag: 'Fracture Costale Isol√©e (suspect√©e)', priority: 2, advice: 'Antalgiques pour permettre respi. Risque de complication (pneumo). √âvacuation pour radio.' });
          } else if (p >= 4) {
             addResult({ tag: 'Contusion Costale / Intercostale', priority: 3, advice: 'Glace, repos. Douleur invalidante mais non-critique.' });
          }
        }
        else if (isAbdoPelvis(loc)) {
          if (p >= 7 || (findings.bleeding && loc === 'abdomen')) addResult({ tag: 'H√©morragie Interne (Rupture de rate/foie suspect√©e)', priority: 1, advice: 'Surveillance signes de choc (p√¢leur, tachy, hypoTA). Transport rapide, bilan √©cho-fast.' });
          else if (p >= 4 && loc === 'abdomen') addResult({ tag: 'Contusion Abdominale (H√©matome pari√©tal)', priority: 3, advice: 'Surveiller "ventre de bois" (d√©fense). Si douleur augmente -> H√¥pital.' });
          
          if (loc === 'bassin' && (p >= 6 || findings.deformity)) {
              addResult({ tag: 'Fracture du Bassin / Disjonction Pubienne', priority: 1, advice: 'Urgence vitale ! Risque h√©morragique majeur. Ne pas mobiliser, ceinture pelvienne (RP), plan dur. √âvacuation.' });
          }
          if (loc === 'lombaires' && p >= 7) {
              addResult({ tag: 'Traumatisme Rachis Lombaire (Fracture/Tassement suspect√©)', priority: 1, advice: 'Immobilisation totale (plan dur), bilan sensitivo-moteur. √âvacuation.' });
          }
        }
        else if (isUpperExt(loc)) {
          if (findings.deformity || p >= 8) {
             addResult({ tag: 'Fracture (Hum√©rus/Radius/Ulna)', priority: 2, advice: 'Immobiliser (attelle, √©charpe). Bilan vasculo-nerveux distal (pouls, sensibilit√©). √âvacuation pour radio.' });
          } else if (p >= 6) {
             addResult({ tag: 'Luxation (√âpaule/Coude) (possible)', priority: 2, advice: 'D√©formation, impotence fonctionnelle. Ne pas r√©duire ! Immobiliser. √âvacuation.' });
          } else if (p >= 4) {
             addResult({ tag: 'Entorse s√©v√®re / Contusion musculaire', priority: 3, advice: 'R.I.C.E. (Repos, Glace...). Si impotence totale, radio.' });
          }
        }
        else if (isLowerExt(loc)) {
          if (findings.deformity || p >= 8) {
            const isFemur = loc.includes('cuisse');
            const tag = isFemur ? 'Fracture du F√©mur (suspect√©e)' : 'Fracture Tibia/P√©ron√© (ouverte/ferm√©e)';
            const prio = isFemur ? 1 : 2;
            const advice = isFemur 
              ? 'P1 - Risque h√©morragique. Attelle traction (RP), antalgiques. √âvacuation rapide.'
              : 'P2 - Attelle. Bilan vasculo-nerveux distal (pouls p√©dieux). √âvacuation radio.';
            addResult({ tag: tag, priority: prio, advice: advice });
          }
          else if (p >= 6) {
             addResult({ tag: 'Entorse Genou/Cheville (LCA/LLE suspect√©)', priority: 3, advice: 'R.I.C.E. Immobilisation. Si appui impossible, radio pour exclure fracture.' });
          } else if (p >= 4) {
             addResult({ tag: 'D√©chirure Musculaire / Contusion', priority: 3, advice: 'Repos, glace. Appui difficile. B√©quilles (RP).' });
          }
        }
      }

      if (!out.length && !findings.gsw && !findings.burn) {
        addResult({ tag: 'Blessures superficielles / RAS', priority: 4, advice: 'Nettoyage des plaies mineures, repos. Pas d\'√©vacuation n√©cessaire.' });
      }

      // Modificateurs g√©n√©raux
      const clamp = (n, min, max) => Math.max(min, Math.min(max, n));
      const extremeAge = Number.isFinite(age) && (age < 18 || age > 65);
      const anticoag = !!(hx && hx.anticoagulants);
      const persist = (delayHours >= 24) && (p >= 6);

      for (const item of out) {
        let pr = item.priority;
        if (anticoag && (locations.some(isHeadNeck) || findings.lossOfConsciousness)) {
            pr = 1; // Haut risque h√©morragique
            item.tag = item.tag + " (SOUS ANTICOAGULANTS)";
        }
        if (extremeAge && pr > 1) pr -= 1; // Augmenter la priorit√© pour les √¢ges extr√™mes
        if (persist && pr > 1) pr -= 1; // Douleur persistante = plus suspect
        item.priority = clamp(pr, 1, 4);
      }

      out.sort((a, b) => a.priority - b.priority);
      return out;
    }
    
    // --- MOTEUR DE DIAGNOSTIC (CONSULTATION) ---
    function computeConsultDiagnosis({ vitals, symptoms, details, age, hx }) {
        const out = [];
        const { fc, spo2, taSys, taDia, hgt, temp } = vitals;

        // Signes de choc / D√©tresse vitale
        if (taSys < 90) out.push({ tag: '√âtat de choc (Hypotension)', priority: 1, advice: 'Remplissage, bilan urgence, transport imm√©diat.' });
        if (spo2 < 94) out.push({ tag: 'D√©tresse respiratoire (Hypoxie)', priority: 1, advice: 'Oxyg√©noth√©rapie, bilan pulmonaire/cardiaque.' });
        if (fc > 120 || fc < 50) out.push({ tag: 'Trouble du rythme (Tachy/Brady)', priority: 1, advice: 'ECG, surveillance monitoring, avis cardio.' });

        // Sc√©narios par sympt√¥me
        if (symptoms.chestpain) {
            let prio = (age > 40 || details.includes('irradi')) ? 1 : 2;
            out.push({ tag: 'Douleur thoracique (SCA suspect)', priority: prio, advice: 'ECG, monitoring, antalgiques, √©vacuation.' });
        }
        if (symptoms.dyspnea && spo2 < 96) {
            out.push({ tag: 'Dyspn√©e (OAP/Asthme/EP suspect)', priority: 2, advice: 'Auscultation, O2 si besoin, bilan.' });
        }
        if (symptoms.confusion) {
            let prio = (hgt < 70 || hgt > 250) ? 1 : 2;
            out.push({ tag: 'Alt√©ration √©tat de conscience', priority: prio, advice: 'Contr√¥le HGT, bilan neuro/m√©tabolique.' });
        }
        if (hgt < 70) {
            out.push({ tag: 'Hypoglyc√©mie', priority: 1, advice: 'Resucrage imm√©diat (oral ou IV).' });
        }
        if (hgt > 250) {
            out.push({ tag: 'Hyperglyc√©mie', priority: 2, advice: 'V√©rifier diab√®te, hydratation, bilan.' });
        }
        if (symptoms.fever) {
            let prio = (temp > 39 || taSys < 100) ? 2 : 3;
            out.push({ tag: 'Syndrome infectieux/fi√®vre', priority: prio, advice: 'Bilan infectieux, parac√©tamol. Si sepsis (hypoTA), urgence.' });
        }
        if (symptoms.abdo) {
            out.push({ tag: 'Douleur abdominale aigu√´', priority: 2, advice: 'Palpation (recherche d√©fense), bilan digestif.' });
        }
        if (symptoms.headache && taSys > 160) {
             out.push({ tag: 'C√©phal√©e (Pouss√©e HTA)', priority: 2, advice: 'Contr√¥le TA, recherche signes neuro.' });
        }
        if (symptoms.dizzy) {
             out.push({ tag: 'Vertiges', priority: 3, advice: 'Bilan ORL/neuro, rassurer.' });
        }
        
        if (!out.length) {
            out.push({ tag: 'Consultation non sp√©cifique', priority: 4, advice: 'R√©√©valuation, antalgiques si besoin.' });
        }

        // Modificateurs
        const clamp = (n, min, max) => Math.max(min, Math.min(max, n));
        const extremeAge = Number.isFinite(age) && (age < 18 || age > 65);
        if (extremeAge) {
            out.forEach(item => { item.priority = clamp(item.priority - 1, 1, 4); });
        }
        
        out.sort((a, b) => a.priority - b.priority);
        const uniqueTags = new Set();
        return out.filter(item => {
            if (uniqueTags.has(item.tag)) return false;
            uniqueTags.add(item.tag);
            return true;
        });
    }

    // --- Rendu des R√©sultats ---
    function renderResults(list) {
      els.results.innerHTML = '';
      if (!list || !list.length) {
        clearResults();
        els.noResults.style.display = 'block';
        return;
      }
      
      els.noResults.style.display = 'none';
      els.metaCount.textContent = `${list.length} hypoth√®se(s)`;
      
      // Score Global
      const minPrio = Math.min(...list.map(item => item.priority));
      const banners = {
        1: { text: 'URGENCE VITALE - TRANSPORT IMM√âDIAT', class: 'triage-p1' },
        2: { text: 'URGENCE RELATIVE - TRANSPORT RECOMMAND√â', class: 'triage-p2' },
        3: { text: 'CONSULTATION N√âCESSAIRE - Transport non-urgent', class: 'triage-p3' },
        4: { text: 'SOINS SUR PLACE / RAS', class: 'triage-p4' }
      };
      const banner = banners[minPrio] || banners[4];
      els.globalTriage.textContent = banner.text;
      els.globalTriage.className = 'callout ' + banner.class;
      els.globalTriage.style.display = 'block';

      // Liste des r√©sultats
      for (const item of list) {
        const div = document.createElement('div');
        div.className = 'result ' + (item.priority === 1 ? 'danger' : item.priority <= 2 ? 'success' : '');
        div.innerHTML = `
          <div class="tag">${item.tag}</div>
          <div class="advice">${item.advice}</div>
          <div class="prio">Priorit√©: ${item.priority}</div>
        `;
        els.results.appendChild(div);
      }
    }
    
    function clearResults() {
        els.results.innerHTML = '';
        els.noResults.style.display = 'block';
        els.metaCount.textContent = '‚Äî';
        els.globalTriage.style.display = 'none';
    }

    // --- R√©cup√©ration des Donn√©es des Formulaires ---
    function getFormValues(mode) {
      const isTrauma = mode === 'trauma';
      const ageVal = parseInt(isTrauma ? els.age.value : els.ageConsult.value, 10);
      const data = {
        formMode: isTrauma ? 'trauma' : 'consultation',
        patientName: (isTrauma ? els.patientName.value : els.patientNameConsult.value).trim(),
        age: Number.isFinite(ageVal) ? ageVal : undefined,
        interventionStartISO: startAt ? startAt.toISOString() : null
      };

      if (isTrauma) {
        const delayHours = parseInt(els.delay.value, 10);
        Object.assign(data, {
          incident: els.incident.value.trim(),
          locations: [...selectedZones], // Copie du tableau
          pain: Number(els.pain.value),
          delayHours: Number.isFinite(delayHours) ? delayHours : 0,
          hx: {
            anticoagulants: !!els.hxAnticoag.checked,
            diabetes: !!els.hxDiabetes.checked,
            immunodepression: !!els.hxImmuno.checked,
          },
          findings: {
            bleeding: els.fBleeding.checked,
            deformity: els.fDeformity.checked,
            lossOfConsciousness: els.fLoc.checked,
            gsw: els.fGSW.checked,
            burn: els.fBurn.checked,
          }
        });
      } else {
        Object.assign(data, {
          vitals: {
            fc: parseInt(els.vitalFc.value, 10) || undefined,
            spo2: parseInt(els.vitalSpo2.value, 10) || undefined,
            taSys: parseInt(els.vitalTaSys.value, 10) || undefined,
            taDia: parseInt(els.vitalTaDia.value, 10) || undefined,
            hgt: parseInt(els.vitalHgt.value, 10) || undefined,
            temp: parseFloat(els.vitalTemp.value) || undefined,
          },
          symptoms: {
            chestpain: els.symChestpain.checked,
            dyspnea: els.symDyspnea.checked,
            fever: els.symFever.checked,
            nausea: els.symNausea.checked,
            dizzy: els.symDizzy.checked,
            confusion: els.symConfusion.checked,
            abdo: els.symAbdo.checked,
            headache: els.symHeadache.checked,
          },
          details: els.consultDetails.value.trim(),
          hx: { // ATCD partag√©s
            anticoagulants: !!els.hxAnticoag.checked,
            diabetes: !!els.hxDiabetes.checked,
            immunodepression: !!els.hxImmuno.checked,
          },
        });
      }
      return data;
    }

    // --- Actions Principales (Calculer, Reset) ---
    function calculate(e) {
      e && e.preventDefault();
      const isTrauma = els.formTrauma.style.display !== 'none';
      if (isTrauma) {
        renderResults(computeTraumaDiagnosis(getFormValues('trauma')));
      } else {
        renderResults(computeConsultDiagnosis(getFormValues('consultation')));
      }
    }

    function resetForm() {
      // Trauma
      els.patientName.value = '';
      els.incident.value = '';
      els.locationDisplay.value = 'Cliquer sur le mannequin...';
      selectedZones = [];
      mapRegions().forEach(el => el.classList.remove('active'));
      els.pain.value = 5; updatePainLabel();
      els.age.value = ''; els.delay.value = '';
      els.hxAnticoag.checked = false; els.hxDiabetes.checked = false; els.hxImmuno.checked = false;
      els.fBleeding.checked = false; els.fDeformity.checked = false; els.fLoc.checked = false; els.fGSW.checked = false; els.fBurn.checked = false;
      
      // Consultation
      els.patientNameConsult.value = '';
      els.ageConsult.value = '';
      els.vitalFc.value = ''; els.vitalSpo2.value = ''; els.vitalTaSys.value = ''; els.vitalTaDia.value = ''; els.vitalHgt.value = ''; els.vitalTemp.value = '';
      els.symChestpain.checked = false; els.symDyspnea.checked = false; els.symFever.checked = false; els.symNausea.checked = false;
      els.symDizzy.checked = false; els.symConfusion.checked = false; els.symAbdo.checked = false; els.symHeadache.checked = false;
      els.consultDetails.value = '';
      
      // Global
      clearResults();
      startAt = null; els.startPill.textContent = 'D√©but: ‚Äî';
      resetChrono(); resetCountdown();
    }
    
    // --- Journal de Bord (LocalStorage) ---
    const JOURNAL_KEY = 'triageJournal_v2';
    
    function saveToJournal(data) {
        try {
            const journal = JSON.parse(localStorage.getItem(JOURNAL_KEY) || '[]');
            journal.push(data);
            if (journal.length > 20) journal.shift(); // Garde les 20 derniers
            localStorage.setItem(JOURNAL_KEY, JSON.stringify(journal));
        } catch (e) { console.error("Erreur sauvegarde journal:", e); }
    }
    
    function loadJournal() {
        els.journalContent.innerHTML = '';
        let journal = [];
        try { journal = JSON.parse(localStorage.getItem(JOURNAL_KEY) || '[]'); }
        catch (e) { console.error("Erreur lecture journal:", e); }
        
        if (!journal.length) {
            els.journalContent.innerHTML = '<p>Aucune intervention enregistr√©e.</p>'; return;
        }
        
        journal.reverse().forEach((entry, index) => { // Plus r√©cent en premier
            const trueIndex = journal.length - 1 - index;
            const div = document.createElement('div');
            div.className = 'journal-entry';
            const prioTag = entry.results && entry.results.length ? entry.results[0].tag : 'N/A';
            const prioNum = entry.results && entry.results.length ? entry.results[0].priority : 'N/A';
            div.innerHTML = `
              <div><strong>${new Date(entry.timestamp).toLocaleString()}</strong> (${entry.formMode || 'trauma'})</div>
              <div><strong>Patient:</strong> ${entry.patientName || '‚Äî'}</div>
              <div><strong>Diagnostic:</strong> ${prioTag} (P${prioNum})</div>
              <button class="btn ghost btn-journal-load" data-index="${trueIndex}">Recharger ce cas</button>
            `;
            els.journalContent.appendChild(div);
        });
        
        document.querySelectorAll('.btn-journal-load').forEach(btn => {
            btn.addEventListener('click', (e) => loadCaseFromJournal(e.target.dataset.index));
        });
    }

    function loadCaseFromJournal(index) {
        let journal = [];
        try { journal = JSON.parse(localStorage.getItem(JOURNAL_KEY) || '[]'); }
        catch (e) { return; }
        
        const entry = journal[index];
        if (!entry) return;
        
        resetForm();
        
        // Donn√©es communes
        els.patientName.value = entry.patientName || '';
        els.patientNameConsult.value = entry.patientName || '';
        const ageStr = (entry.age !== undefined) ? String(entry.age) : '';
        els.age.value = ageStr;
        els.ageConsult.value = ageStr;
        if (entry.interventionStartISO) {
            startAt = new Date(entry.interventionStartISO);
            els.startPill.textContent = 'D√©but: ' + fmtDateTime(startAt);
        }
        if (entry.hx) {
            els.hxAnticoag.checked = !!entry.hx.anticoagulants;
            els.hxDiabetes.checked = !!entry.hx.diabetes;
            els.hxImmuno.checked = !!entry.hx.immunodepression;
        }

        if (entry.formMode === 'consultation') {
            setActiveTab('consultation');
            if (entry.vitals) {
                els.vitalFc.value = entry.vitals.fc || '';
                els.vitalSpo2.value = entry.vitals.spo2 || '';
                els.vitalTaSys.value = entry.vitals.taSys || '';
                els.vitalTaDia.value = entry.vitals.taDia || '';
                els.vitalHgt.value = entry.vitals.hgt || '';
                els.vitalTemp.value = entry.vitals.temp || '';
            }
            if (entry.symptoms) {
                els.symChestpain.checked = !!entry.symptoms.chestpain;
                els.symDyspnea.checked = !!entry.symptoms.dyspnea;
                els.symFever.checked = !!entry.symptoms.fever;
                els.symNausea.checked = !!entry.symptoms.nausea;
                els.symDizzy.checked = !!entry.symptoms.dizzy;
                els.symConfusion.checked = !!entry.symptoms.confusion;
                els.symAbdo.checked = !!entry.symptoms.abdo;
                els.symHeadache.checked = !!entry.symptoms.headache;
            }
            els.consultDetails.value = entry.details || '';
        } else {
            // D√©faut sur Trauma
            setActiveTab('trauma');
            els.incident.value = entry.incident || '';
            selectedZones = entry.locations || [];
            els.locationDisplay.value = selectedZones.join(', ') || 'Cliquer sur le mannequin...';
            mapRegions().forEach(el => {
                el.classList.toggle('active', selectedZones.includes(el.dataset.zone));
            });
            els.pain.value = entry.pain || 5; updatePainLabel();
            els.delay.value = entry.delayHours || '';
            if (entry.findings) {
                els.fBleeding.checked = !!entry.findings.bleeding;
                els.fDeformity.checked = !!entry.findings.deformity;
                els.fLoc.checked = !!entry.findings.lossOfConsciousness;
                els.fGSW.checked = !!entry.findings.gsw;
                els.fBurn.checked = !!entry.findings.burn;
            }
        }
        
        renderResults(entry.results || []);
        els.journalModal.style.display = 'none';
    }

    function clearJournal() {
        if (confirm('Voulez-vous vraiment vider tout le journal de bord ?')) {
            localStorage.removeItem(JOURNAL_KEY);
            loadJournal();
        }
    }
    
    function getResultsForStorage() {
        return Array.from(els.results.querySelectorAll('.result')).map(div => ({
            tag: div.querySelector('.tag')?.textContent || '',
            priority: Number((div.querySelector('.prio')?.textContent || '').replace(/[^0-9]/g,'')),
            advice: div.querySelector('.advice')?.textContent || ''
        }));
    }

    // --- Export / Copie ---
    function exportJSON() {
      const isTrauma = els.formTrauma.style.display !== 'none';
      const data = getFormValues(isTrauma ? 'trauma' : 'consultation');
      const fullData = {
          ...data,
          results: getResultsForStorage(),
          timestamp: new Date().toISOString()
      };
      saveToJournal(fullData); // Sauvegarde lors de l'export
      
      const blob = new Blob([JSON.stringify(fullData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `ems_case_${Date.now()}.json`;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    function copySummary() {
      const isTrauma = els.formTrauma.style.display !== 'none';
      const v = getFormValues(isTrauma ? 'trauma' : 'consultation');
      const resData = getResultsForStorage();
      
      // Sauvegarde lors de la copie
      saveToJournal({ ...v, results: resData, timestamp: new Date().toISOString() });
      
      let txt = `R√©sum√© RP ‚Äî ${isTrauma ? 'Triage Trauma' : 'Consultation'}\n`;
      if (v.interventionStartISO) {
        txt += `D√©but intervention: ${fmtDateTime(new Date(v.interventionStartISO))}\n`;
      }
      txt += `Patient: ${v.patientName || '‚Äî'}\n`;
      if (v.age !== undefined) txt += `√Çge: ${v.age}\n`;

      const atcd = [];
      if (v.hx.anticoagulants) atcd.push('anticoagulants');
      if (v.hx.diabetes) atcd.push('diab√®te');
      if (v.hx.immunodepression) atcd.push('immunod√©pression');
      if (atcd.length) txt += `ATCD: ${atcd.join(', ')}\n`;
      txt += `\n--- √âVALUATION ---\n`;
      
      if (isTrauma) {
          txt += `Incident: ${v.incident || '‚Äî'}\n`;
          if (v.delayHours) txt += `D√©lai: ${v.delayHours}h\n`;
          txt += `Zone(s): ${v.locations.join(', ') || '‚Äî'}\nDouleur: ${v.pain}/10\n`;
          const signes = [];
          if (v.findings.gsw) signes.push('blessure par balle (GSW)');
          if (v.findings.bleeding) signes.push('saignement important');
          if (v.findings.deformity) signes.push('d√©formation');
          if (v.findings.lossOfConsciousness) signes.push('PDC/confusion');
          if (v.findings.burn) signes.push('br√ªlure');
          if (signes.length) txt += `Signes: ${signes.join(', ')}\n`;
      } else {
          txt += `Sympt√¥mes: ${Object.entries(v.symptoms).filter(([k,v]) => v).map(([k]) => k.replace('sym-','')).join(', ') || 'aucun'}\n`;
          txt += `Vitals: FC:${v.vitals.fc || 'N/A'} | SpO2:${v.vitals.spo2 || 'N/A'}% | TA:${v.vitals.taSys || 'N/A'}/${v.vitals.taDia || 'N/A'} | HGT:${v.vitals.hgt || 'N/A'} | T¬∞:${v.vitals.temp || 'N/A'}\n`;
          if (v.details) txt += `D√©tails: ${v.details}\n`;
      }
      
      if (resData.length) {
        txt += `\n--- R√âSULTATS ---\n`;
        resData.forEach(item => {
          txt += ` - ${item.tag} (P${item.priority}) ‚Äî ${item.advice}\n`;
        });
      } else { txt += `R√©sultats: ‚Äî\n`; }
      
      navigator.clipboard.writeText(txt).then(() => {
        const old = els.btnCopy.textContent;
        els.btnCopy.textContent = '‚úî R√©sum√© copi√©';
        setTimeout(() => els.btnCopy.textContent = old, 1200);
      });
    }

    // --- G√©n√©rateurs de vitaux al√©atoires ---
    
    // Helper: nombre al√©atoire entre min (inclus) et max (inclus)
    function randInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }
    // Helper: nombre al√©atoire (float, 1 d√©cimale)
    function randFloat(min, max) {
      return (Math.random() * (max - min) + min).toFixed(1);
    }

    /**
     * G√©n√®re une valeur vitale avec 80% de chance d'√™tre normale, 20% anormale.
     */
    function generateVital(normalMin, normalMax, abnormalLowMin, abnormalLowMax, abnormalHighMin, abnormalHighMax, isFloat = false) {
      const isAbnormal = Math.random() < 0.20; // 20% de chance
      const randFunc = isFloat ? randFloat : randInt;

      if (isAbnormal) {
        // 50/50 chance d'√™tre bas ou haut (sauf si les plages sont identiques)
        const isLow = Math.random() < 0.5;
        if (isLow && abnormalLowMin !== abnormalLowMax) {
          return randFunc(abnormalLowMin, abnormalLowMax);
        } else {
          return randFunc(abnormalHighMin, abnormalHighMax);
        }
      } else {
        return randFunc(normalMin, normalMax);
      }
    }


    // --- Initialisation et √âcouteurs ---
    els.year.textContent = new Date().getFullYear();
    // Tabs
    els.btnTabTrauma.addEventListener('click', () => setActiveTab('trauma'));
    els.btnTabConsult.addEventListener('click', () => setActiveTab('consultation'));
    // Header
    els.btnStart.addEventListener('click', setStartNow);
    els.btnPrint.addEventListener('click', () => window.print());
    // Timers
    els.btnChronoStart.addEventListener('click', startChrono);
    els.btnChronoStop.addEventListener('click', stopChrono);
    els.btnChronoReset.addEventListener('click', resetChrono);
    els.btnCountdownStart.addEventListener('click', startCountdown);
    els.btnCountdownStop.addEventListener('click', stopCountdown);
    els.btnCountdownReset.addEventListener('click', resetCountdown);
    // Formulaires
    els.btnCalc.addEventListener('click', calculate);
    els.btnReset.addEventListener('click', resetForm);
    // R√©sultats
    els.btnExport.addEventListener('click', exportJSON);
    els.btnCopy.addEventListener('click', copySummary);
    // Journal
    els.btnJournal.addEventListener('click', () => { loadJournal(); els.journalModal.style.display = 'block'; });
    els.btnJournalClose.addEventListener('click', () => els.journalModal.style.display = 'none');
    els.btnJournalClear.addEventListener('click', clearJournal);
    els.journalModal.addEventListener('click', (e) => { if (e.target === els.journalModal) els.journalModal.style.display = 'none'; });

    // --- √âcouteurs pour Vitals Al√©atoires ---
    document.querySelector('label[for="vital-fc"]').addEventListener('click', (e) => {
      e.preventDefault(); // Emp√™che le focus sur l'input
      els.vitalFc.value = generateVital(60, 100, 45, 59, 101, 140);
    });
    document.querySelector('label[for="vital-spo2"]').addEventListener('click', (e) => {
      e.preventDefault();
      // Pour SpO2, une anomalie est presque toujours basse
      els.vitalSpo2.value = generateVital(95, 100, 88, 94, 88, 94); 
    });
    document.querySelector('label[for="vital-ta-sys"]').addEventListener('click', (e) => {
      e.preventDefault();
      els.vitalTaSys.value = generateVital(100, 140, 75, 89, 161, 190);
    });
    document.querySelector('label[for="vital-ta-dia"]').addEventListener('click', (e) => {
      e.preventDefault();
      els.vitalTaDia.value = generateVital(60, 90, 40, 49, 101, 110);
    });
    document.querySelector('label[for="vital-hgt"]').addEventListener('click', (e) => {
      e.preventDefault();
      els.vitalHgt.value = generateVital(70, 120, 40, 69, 181, 300);
    });
    document.querySelector('label[for="vital-temp"]').addEventListener('click', (e) => {
      e.preventDefault();
      els.vitalTemp.value = generateVital(36.5, 37.5, 35.0, 35.9, 38.1, 39.5, true);
    });


    // Initialisation
    updatePainLabel();
    setActiveTab('trauma'); // Ouvre sur l'onglet Trauma
    clearResults();
  </script>
</body>
</html>
