<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GTA-RP Trauma Triage — Pré-diagnostic</title>
  <style>
    :root {
      --bg: #0f172a; /* slate-900 */
      --card: #0b1220; /* darker */
      --text: #e2e8f0; /* slate-200 */
      --muted: #94a3b8; /* slate-400 */
      --accent: #6366f1; /* indigo-500 */
      --accent-2: #22c55e; /* green-500 */
      --warn: #f59e0b; /* amber-500 */
      --danger: #ef4444; /* red-500 */
      --border: #1f2937; /* gray-800 */
      --chip: #111827; /* gray-900 */
    }
    * { box-sizing: border-box; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 600px at 20% -10%, #1e293b 0, #0b1020 60%, #060913 100%);
      color: var(--text);
    }
    .container { max-width: 980px; margin: 40px auto; padding: 0 16px; }
    header { display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:20px; }
    .brand { display:flex; align-items:center; gap:12px; }
    .logo { width:40px; height:40px; border-radius:12px; background: linear-gradient(135deg, var(--accent), #8b5cf6); box-shadow: 0 10px 25px rgba(99,102,241,.35); }
    h1 { font-size: clamp(22px, 3vw, 28px); margin:0; letter-spacing: .2px; }
    .card { background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015)); border:1px solid var(--border); border-radius: 18px; padding: 18px; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
    .grid { display:grid; grid-template-columns: 1fr; gap: 16px; }
    @media (min-width: 900px) { .grid { grid-template-columns: 1.1fr .9fr; } }
    label { font-size: 14px; color: var(--muted); display:block; margin-bottom:6px; }
    textarea, select, input[type="text"] { width:100%; background:#0a0f1b; color:var(--text); border:1px solid #192133; padding:10px 12px; border-radius:12px; outline:none; }
    textarea:focus, select:focus, input[type="text"]:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(99,102,241,.25); }
    .range-wrap { background:#0a0f1b; border:1px solid #192133; padding:12px; border-radius:12px; }
    input[type="range"] { width:100%; }
    .row { display:flex; flex-wrap:wrap; gap:12px; }
    .chip { display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:12px; background: var(--chip); border:1px solid #1f2937; font-size: 14px; }
    .btns { display:flex; gap:10px; flex-wrap:wrap; }
    .btn { background: var(--accent); color:white; border:none; padding:10px 14px; border-radius:14px; cursor:pointer; font-weight:600; letter-spacing:.2px; }
    .btn.secondary { background:transparent; border:1px solid #334155; color: var(--text); }
    .btn.ghost { background:transparent; color: var(--muted); }
    .section-title { font-size:18px; font-weight:700; margin: 6px 0 10px; }
    .results { display:grid; gap:12px; }
    .result { border:1px solid #1f2937; border-left:4px solid var(--accent); padding:12px; border-radius:12px; background:#0a0f1b; }
    .prio { font-size:12px; color:#cbd5e1; opacity:.9; }
    .tag { font-weight:700; }
    .advice { color:#cbd5e1; margin-top:4px; }
    .callout { background: rgba(245, 158, 11, .1); border:1px solid rgba(245, 158, 11, .35); color:#fde68a; border-radius:12px; padding:10px 12px; font-size:14px; }
    footer { margin-top: 16px; color: #94a3b8; font-size: 12px; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; background:#0b1220; border:1px solid #1f2937; padding:2px 6px; border-radius:6px; }
    .titlebar { display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:12px; }
    .pill { font-size:12px; padding:6px 10px; border:1px solid #334155; border-radius:999px; color:#a5b4fc; background: rgba(99,102,241,.08); }
    .success { border-left-color: var(--accent-2); }
    .danger { border-left-color: var(--danger); }

    /* === Body-map (ajout) === */
    .bodymap {
      display:flex; align-items:center; gap:12px; margin-top:8px;
    }
    .bodymap .mapwrap {
      background:#0a0f1b; border:1px solid #192133; border-radius:12px;
      padding:8px; width:220px; min-width:220px;
    }
    .bodymap-hint { font-size:12px; color:var(--muted); }
    .bm-region {
      fill:#0b1220; stroke:#263043; stroke-width:1.2;
      cursor:pointer;
      transition:fill .15s ease, stroke .15s ease;
    }
    .bm-region:hover, .bm-region:focus {
      outline:none; fill:#111a2e; stroke:#7c89ff;
    }
    .bm-region.active {
      fill:rgba(99,102,241,.25); stroke:#8b5cf6;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Trauma Triage — Outil de <strong>pré</strong>-diagnostic</h1>
          <div class="pill" aria-live="polite">Diagnostique d'intervention rapide· Ne remplace pas un avis médical poussé à l'hopital</div>
        </div>
      </div>
      <div class="row">
        <button class="btn ghost" id="btn-export-json" title="Exporter le cas (JSON)">Exporter</button>
        <button class="btn ghost" id="btn-print" title="Imprimer / PDF">Imprimer</button>
      </div>
    </header>

    <div class="grid">
      <!-- Formulaire -->
      <section class="card" aria-labelledby="form-title">
        <div class="titlebar">
          <div class="section-title" id="form-title">Entrée patient RP</div>
          <div class="prio">Remplissez les champs puis cliquez <span class="kbd">Calculer</span></div>
        </div>

        <div class="row" style="gap:16px">
          <div style="flex:1 1 100%">
            <label for="incident">Que s'est-il passé ? (résumé court)</label>
            <textarea id="incident" rows="3" placeholder="Ex.: chute de moto à 80 km/h, impact tête/épaule, casque porté"></textarea>
          </div>

          <div style="flex:1 1 220px; min-width: 220px;">
            <label for="location">Localisation principale de la douleur</label>

            <!-- ===== Body-map ajoutée (synchronisée avec le select) ===== -->
            <div class="bodymap" aria-label="Carte du corps cliquable">
              <div class="mapwrap">
                <svg viewBox="0 0 120 260" width="100%" role="img" aria-labelledby="bmTitle">
                  <title id="bmTitle">Body-map simplifiée</title>
                  <!-- Tête -->
                  <circle class="bm-region" tabindex="0" data-zone="head" cx="60" cy="25" r="18">
                    <title>Tête / Crâne</title>
                  </circle>
                  <!-- Cou -->
                  <rect class="bm-region" tabindex="0" data-zone="neck" x="50" y="45" width="20" height="16" rx="4">
                    <title>Cou / Gorge</title>
                  </rect>
                  <!-- Thorax -->
                  <rect class="bm-region" tabindex="0" data-zone="chest" x="38" y="62" width="44" height="38" rx="6">
                    <title>Thorax / Poitrine</title>
                  </rect>
                  <!-- Abdomen -->
                  <rect class="bm-region" tabindex="0" data-zone="abdomen" x="40" y="102" width="40" height="36" rx="6">
                    <title>Abdomen / Ventre</title>
                  </rect>
                  <!-- Bassin -->
                  <rect class="bm-region" tabindex="0" data-zone="pelvis" x="42" y="140" width="36" height="24" rx="6">
                    <title>Bassin</title>
                  </rect>
                  <!-- Dos (zone post) : on le rend cliquable ici aussi pour simplicité -->
                  <rect class="bm-region" tabindex="0" data-zone="back" x="30" y="80" width="20" height="52" rx="6" transform="translate(60,0) scale(-1,1)">
                    <title>Dos</title>
                  </rect>
                  <!-- Membres supérieurs gauche/droite -->
                  <rect class="bm-region" tabindex="0" data-zone="upper_ext" x="18" y="68" width="18" height="52" rx="8">
                    <title>Membres supérieurs</title>
                  </rect>
                  <rect class="bm-region" tabindex="0" data-zone="upper_ext" x="84" y="68" width="18" height="52" rx="8">
                    <title>Membres supérieurs</title>
                  </rect>
                  <!-- Membres inférieurs gauche/droite -->
                  <rect class="bm-region" tabindex="0" data-zone="lower_ext" x="46" y="166" width="12" height="70" rx="6">
                    <title>Membres inférieurs</title>
                  </rect>
                  <rect class="bm-region" tabindex="0" data-zone="lower_ext" x="62" y="166" width="12" height="70" rx="6">
                    <title>Membres inférieurs</title>
                  </rect>
                </svg>
                <div class="bodymap-hint">Clique une zone — le sélecteur se mettra à jour.</div>
              </div>

              <div style="flex:1">
                <select id="location">
                  <option value="head">Tête / Crâne</option>
                  <option value="neck">Cou / Gorge</option>
                  <option value="chest">Thorax / Poitrine</option>
                  <option value="abdomen">Abdomen / Ventre</option>
                  <option value="pelvis">Bassin</option>
                  <option value="upper_ext">Membres supérieurs</option>
                  <option value="lower_ext">Membres inférieurs</option>
                  <option value="back">Dos</option>
                  <option value="skin">Peau / Plaies</option>
                </select>
              </div>
            </div>
            <!-- ===== fin body-map ===== -->

          </div>

          <div style="flex:1 1 260px; min-width: 260px;">
            <label for="pain">Niveau de douleur (1–10)</label>
            <div class="range-wrap">
              <input id="pain" type="range" min="1" max="10" value="5" step="1" />
              <div style="display:flex; justify-content:space-between; margin-top:6px; font-size:12px; color:var(--muted)">
                <span>1</span><span>5</span><span>10</span>
              </div>
              <div id="pain-label" style="margin-top:6px; font-weight:600;">Sévérité: 5 — Modérée</div>
            </div>
          </div>
        </div>

        <!-- Champs complémentaires -->
        <div class="row" style="margin-top:10px; gap:12px">
          <div style="flex:1 1 160px; min-width:160px;">
            <label for="age">Âge</label>
            <input type="text" id="age" placeholder="ex. 28" />
          </div>
          <div style="flex:1 1 200px; min-width:200px;">
            <label for="delay">Délai depuis l'incident (heures)</label>
            <input type="text" id="delay" placeholder="ex. 3" />
          </div>
          <div style="flex:2 1 260px; min-width:260px;">
            <label>ATCD (cocher si présents)</label>
            <div class="row">
              <label class="chip"><input type="checkbox" id="hx-anticoag" /> Anticoagulants/AA</label>
              <label class="chip"><input type="checkbox" id="hx-diabetes" /> Diabète</label>
              <label class="chip"><input type="checkbox" id="hx-immuno" /> Immunodépression</label>
            </div>
          </div>
        </div>

        <div style="margin-top:10px">
          <label>Signes visibles (cocher si présents)</label>
          <div class="row">
            <label class="chip"><input type="checkbox" id="f-bleeding" /> Saignement important</label>
            <label class="chip"><input type="checkbox" id="f-deformity" /> Déformation</label>
            <label class="chip"><input type="checkbox" id="f-loc" /> Perte de conscience / confusion</label>
          </div>
        </div>

        <div class="btns" style="margin-top:14px">
          <button class="btn" id="btn-calc">Calculer</button>
          <button class="btn secondary" id="btn-reset" type="button">Réinitialiser</button>
        </div>
      </section>

      <!-- Résultats -->
      <section class="card" aria-labelledby="res-title">
        <div class="titlebar">
          <div class="section-title" id="res-title">Résultats (pré-diagnostic)</div>
          <div class="prio" id="meta-count">—</div>
        </div>
        <div id="results" class="results" aria-live="polite"></div>
        <div id="no-results" class="callout" style="display:none; margin-top:8px">Aucun résultat. Saisissez des informations puis cliquez <span class="kbd">Calculer</span>.</div>

        <!-- Bouton copier -->
        <button class="btn" id="btn-copy" style="margin-top:10px; width:100%">📋 Copier le résumé</button>
      </section>
    </div>

    <footer>
      <p>© <span id="year"></span> — Trauma Triage.</p>
    </footer>
  </div>

  <script>
    const els = {
      incident: document.getElementById('incident'),
      location: document.getElementById('location'),
      pain: document.getElementById('pain'),
      painLabel: document.getElementById('pain-label'),
      age: document.getElementById('age'),
      delay: document.getElementById('delay'),
      hxAnticoag: document.getElementById('hx-anticoag'),
      hxDiabetes: document.getElementById('hx-diabetes'),
      hxImmuno: document.getElementById('hx-immuno'),
      fBleeding: document.getElementById('f-bleeding'),
      fDeformity: document.getElementById('f-deformity'),
      fLoc: document.getElementById('f-loc'),
      btnCalc: document.getElementById('btn-calc'),
      btnReset: document.getElementById('btn-reset'),
      btnExport: document.getElementById('btn-export-json'),
      btnPrint: document.getElementById('btn-print'),
      btnCopy: document.getElementById('btn-copy'),
      results: document.getElementById('results'),
      noResults: document.getElementById('no-results'),
      metaCount: document.getElementById('meta-count'),
    };

    // --- Body-map sync (ajout) ---
    const mapRegions = () => Array.from(document.querySelectorAll('.bm-region'));
    function highlight(zone){
      mapRegions().forEach(el=> el.classList.toggle('active', el.dataset.zone === zone));
    }
    function setLocation(zone){
      if(!zone) return;
      els.location.value = zone;
      highlight(zone);
    }
    // click + clavier
    mapRegions().forEach(el=>{
      el.addEventListener('click', ()=> setLocation(el.dataset.zone));
      el.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' ') { e.preventDefault(); setLocation(el.dataset.zone);} });
    });
    // synchroniser quand l’utilisateur change le select
    els.location.addEventListener('change', ()=> highlight(els.location.value));
    // init highlight
    highlight(els.location.value);

    // Pain label update
    function updatePainLabel() {
      const v = Number(els.pain.value);
      const band = v <= 3 ? 'Faible' : v <= 7 ? 'Modérée' : 'Sévère';
      els.painLabel.textContent = `Sévérité: ${v} — ${band}`;
    }
    els.pain.addEventListener('input', updatePainLabel);
    updatePainLabel();

    // Core pre-diagnosis engine + Modificateurs (âge/délai/ATCD)
    function computePreDiagnosis({ location, pain, findings, age, delayHours, hx }) {
      const out = [];
      const painSeverity = Number(pain);

      // Immediate red flags
      if (findings.bleeding) out.push({ tag: 'Hémorragie', priority: 1, advice: 'Comprimer la plaie, pansement compressif, évacuation rapide.' });
      if (findings.lossOfConsciousness) out.push({ tag: 'Traumatisme crânien suspect', priority: 1, advice: "Surveillance neurologique, immobilisation tête/cou si mécanisme violent, évacuation." });

      // Head / neck
      if (location === 'head' || location === 'neck') {
        if (painSeverity >= 8) {
          out.push({ tag: 'Traumatisme crânien modéré/sévère', priority: 2, advice: 'Céphalées intenses, vomissements, troubles -> évacuer.' });
        } else if (painSeverity >= 4) {
          out.push({ tag: 'Commotion / contusion', priority: 3, advice: 'Repos, glace, surveillance 24h RP.' });
        } else {
          out.push({ tag: 'Contusion légère', priority: 4, advice: 'Glace locale, repos, réévaluer.' });
        }
      }

      // Chest
      if (location === 'chest') {
        if (painSeverity >= 8 || findings.deformity) {
          out.push({ tag: 'Blessure thoracique grave (pneumothorax/contusion costale)', priority: 1, advice: 'Détresse respi possible — position demi-assise, évacuation urgente.' });
        } else if (painSeverity >= 5) {
          out.push({ tag: 'Fracture costale ou contusion', priority: 2, advice: 'Immobiliser si possible, analgésie RP, surveiller dyspnée.' });
        } else {
          out.push({ tag: 'Douleur thoracique mineure', priority: 3, advice: 'Repos et surveillance.' });
        }
      }

      // Abdomen / pelvis
      if (location === 'abdomen' || location === 'pelvis') {
        if (painSeverity >= 7 || findings.bleeding) {
          out.push({ tag: "Hémorragie interne / lésion viscérale (suspectée)", priority: 1, advice: "Transport rapide, surveiller signes de choc (pâleur, sueurs)." });
        } else if (painSeverity >= 4) {
          out.push({ tag: 'Contusion abdominale', priority: 2, advice: 'Surveillance douleur, défense/rigidité -> évacuation RP.' });
        } else {
          out.push({ tag: 'Douleur abdominale mineure', priority: 4, advice: 'Repos, hydratation, réévaluation.' });
        }
      }

      // Extremities
      if (location === 'upper_ext' || location === 'lower_ext') {
        if (findings.deformity || painSeverity >= 8) {
          out.push({ tag: 'Fracture possible', priority: 2, advice: 'Immobiliser (attelle), contrôler saignement, évacuation pour imagerie (RP).' });
        } else if (painSeverity >= 5) {
          out.push({ tag: 'Entorse / contusion sévère', priority: 3, advice: 'RICE (Repos, Ice, Compression, Élévation).' });
        } else {
          out.push({ tag: 'Contusion / éraflure', priority: 4, advice: 'Nettoyage, pansement, surveillance.' });
        }
      }

      // Back
      if (location === 'back') {
        if (painSeverity >= 7 || findings.deformity || findings.lossOfConsciousness) {
          out.push({ tag: 'Lésion rachidienne suspecte', priority: 1, advice: 'Immobiliser colonne, ne pas mobiliser, évacuation.' });
        } else {
          out.push({ tag: 'Douleur dorsale / contusion', priority: 3, advice: 'Repos, chaleur douce, réévaluation.' });
        }
      }

      // Skin
      if (location === 'skin') {
        if (painSeverity >= 6 || findings.bleeding) {
          out.push({ tag: 'Plaie ouverte / lacération', priority: 2, advice: 'Nettoyer (RP), compresser, envisager suture (RP) selon taille.' });
        } else {
          out.push({ tag: 'Égratignure / abrasion', priority: 4, advice: 'Nettoyage doux et pansement.' });
        }
      }

      if (!out.length) out.push({ tag: 'Évaluation non spécifique', priority: 4, advice: 'Surveillance, éviter activité, réévaluation.' });

      // ---- Modificateurs de priorité (RP heuristiques) ----
      const clamp = (n, min, max) => Math.max(min, Math.min(max, n));
      const extremeAge = Number.isFinite(age) && (age < 18 || age > 65);
      const anticoag = !!(hx && hx.anticoagulants);
      const severePainPersist = (delayHours >= 24) && (painSeverity >= 6);

      for (const item of out) {
        let p = item.priority;

        // Anticoagulants + Tête/Cou ou perte de connaissance => urgence
        if (anticoag && (location === 'head' || location === 'neck' || findings.lossOfConsciousness)) {
          p = 1;
        }
        // Âge extrême : remonter d'un cran si pas déjà au max
        if (extremeAge && p > 1) p -= 1;
        // Douleur importante persistante >24h : remonter d'un cran
        if (severePainPersist && p > 1) p -= 1;

        item.priority = clamp(p, 1, 4);
      }

      out.sort((a, b) => a.priority - b.priority);
      return out;
    }

    function renderResults(list) {
      els.results.innerHTML = '';
      if (!list || !list.length) {
        els.noResults.style.display = 'block';
        els.metaCount.textContent = '—';
        return;
      }
      els.noResults.style.display = 'none';
      els.metaCount.textContent = `${list.length} hypothèse(s)`;
      for (const item of list) {
        const div = document.createElement('div');
        div.className = 'result ' + (item.priority === 1 ? 'danger' : item.priority === 2 ? 'success' : '');
        div.innerHTML = `
          <div class="tag">${item.tag}</div>
          <div class="advice">${item.advice}</div>
          <div class="prio">Priorité: ${item.priority}</div>
        `;
        els.results.appendChild(div);
      }
    }

    function getFormValues() {
      const age = parseInt(els.age.value, 10);
      const delayHours = parseInt(els.delay.value, 10);
      return {
        incident: els.incident.value.trim(),
        location: els.location.value,
        pain: Number(els.pain.value),
        age: Number.isFinite(age) ? age : undefined,
        delayHours: Number.isFinite(delayHours) ? delayHours : 0,
        hx: {
          anticoagulants: !!els.hxAnticoag.checked,
          diabetes: !!els.hxDiabetes.checked,
          immunodepression: !!els.hxImmuno.checked,
        },
        findings: {
          bleeding: els.fBleeding.checked,
          deformity: els.fDeformity.checked,
          lossOfConsciousness: els.fLoc.checked,
        }
      };
    }

    function calculate(e) {
      e && e.preventDefault();
      const payload = getFormValues();
      const res = computePreDiagnosis(payload);
      renderResults(res);
    }

    function resetForm() {
      els.incident.value = '';
      els.location.value = 'head';
      els.pain.value = 5; updatePainLabel();
      els.age.value = '';
      els.delay.value = '';
      els.hxAnticoag.checked = false;
      els.hxDiabetes.checked = false;
      els.hxImmuno.checked = false;
      els.fBleeding.checked = false;
      els.fDeformity.checked = false;
      els.fLoc.checked = false;
      els.results.innerHTML = '';
      els.noResults.style.display = 'block';
      els.metaCount.textContent = '—';
      highlight(els.location.value);
    }

    function exportJSON() {
      const data = {
        ...getFormValues(),
        results: Array.from(els.results.querySelectorAll('.result')).map(div => ({
          tag: div.querySelector('.tag')?.textContent || '',
          priority: Number((div.querySelector('.prio')?.textContent || '').replace(/[^0-9]/g,'')),
        })),
        timestamp: new Date().toISOString()
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `triage_case_${Date.now()}.json`;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    function copySummary() {
      const v = getFormValues();
      const resCards = els.results.querySelectorAll('.result');
      let txt = `Résumé RP — Trauma Triage\n`;
      txt += `Incident: ${v.incident || '—'}\n`;
      txt += `Zone: ${v.location}\nDouleur: ${v.pain}/10\n`;
      if (v.age !== undefined) txt += `Âge: ${v.age}\n`;
      if (v.delayHours) txt += `Délai: ${v.delayHours}h\n`;
      const atcd = [];
      if (v.hx.anticoagulants) atcd.push('anticoagulants/AA');
      if (v.hx.diabetes) atcd.push('diabète');
      if (v.hx.immunodepression) atcd.push('immunodépression');
      if (atcd.length) txt += `ATCD: ${atcd.join(', ')}\n`;
      if (resCards.length) {
        txt += `Résultats:\n`;
        resCards.forEach(card => {
          const t = card.querySelector('.tag')?.textContent || '';
          const p = card.querySelector('.prio')?.textContent.replace(/[^0-9]/g,'') || '';
          const a = card.querySelector('.advice')?.textContent || '';
          txt += ` - ${t} (P${p}) — ${a}\n`;
        });
      } else {
        txt += `Résultats: —\n`;
      }
      navigator.clipboard.writeText(txt).then(() => {
        const old = els.btnCopy.textContent;
        els.btnCopy.textContent = '✔ Résumé copié';
        setTimeout(() => els.btnCopy.textContent = old, 1200);
      });
    }

    document.getElementById('year').textContent = new Date().getFullYear();
    els.btnCalc.addEventListener('click', calculate);
    els.btnReset.addEventListener('click', resetForm);
    els.btnExport.addEventListener('click', exportJSON);
    els.btnPrint.addEventListener('click', () => window.print());
    els.btnCopy.addEventListener('click', copySummary);

    // Initial state
    resetForm();
  </script>
</body>
</html>
