<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GTA-RP Trauma Triage — Pré-diagnostic</title>
  <style>
    :root {
      --bg: #0f172a; /* slate-900 */
      --card: #0b1220; /* darker */
      --text: #e2e8f0; /* slate-200 */
      --muted: #94a3b8; /* slate-400 */
      --accent: #6366f1; /* indigo-500 */
      --accent-2: #22c55e; /* green-500 */
      --warn: #f59e0b; /* amber-500 */
      --danger: #ef4444; /* red-500 */
      --border: #1f2937; /* gray-800 */
      --chip: #111827; /* gray-900 */
    }
    * { box-sizing: border-box; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 600px at 20% -10%, #1e293b 0, #0b1020 60%, #060913 100%);
      color: var(--text);
    }
    .container { max-width: 980px; margin: 40px auto; padding: 0 16px; }
    header { display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:20px; }
    .brand { display:flex; align-items:center; gap:12px; }
    .logo { width:40px; height:40px; border-radius:12px; background: linear-gradient(135deg, var(--accent), #8b5cf6); box-shadow: 0 10px 25px rgba(99,102,241,.35); }
    h1 { font-size: clamp(22px, 3vw, 28px); margin:0; letter-spacing: .2px; }
    .card { background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015)); border:1px solid var(--border); border-radius: 18px; padding: 18px; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
    .grid { display:grid; grid-template-columns: 1fr; gap: 16px; }
    @media (min-width: 900px) { .grid { grid-template-columns: 1.1fr .9fr; } }
    label { font-size: 14px; color: var(--muted); display:block; margin-bottom:6px; }
    textarea, select, input[type="text"] { width:100%; background:#0a0f1b; color:var(--text); border:1px solid #192133; padding:10px 12px; border-radius:12px; outline:none; }
    textarea:focus, select:focus, input[type="text"]:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(99,102,241,.25); }
    .range-wrap { background:#0a0f1b; border:1px solid #192133; padding:12px; border-radius:12px; }
    input[type="range"] { width:100%; }
    .row { display:flex; flex-wrap:wrap; gap:12px; }
    .chip { display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:12px; background: var(--chip); border:1px solid #1f2937; font-size: 14px; }
    .btns { display:flex; gap:10px; flex-wrap:wrap; }
    .btn { background: var(--accent); color:white; border:none; padding:10px 14px; border-radius:14px; cursor:pointer; font-weight:600; letter-spacing:.2px; }
    .btn.secondary { background:transparent; border:1px solid #334155; color: var(--text); }
    .btn.ghost { background:transparent; color: var(--muted); }
    .section-title { font-size:18px; font-weight:700; margin: 6px 0 10px; }
    .results { display:grid; gap:12px; }
    .result { border:1px solid #1f2937; border-left:4px solid var(--accent); padding:12px; border-radius:12px; background:#0a0f1b; }
    .prio { font-size:12px; color:#cbd5e1; opacity:.9; }
    .tag { font-weight:700; }
    .advice { color:#cbd5e1; margin-top:4px; }
    .callout { background: rgba(245, 158, 11, .1); border:1px solid rgba(245, 158, 11, .35); color:#fde68a; border-radius:12px; padding:10px 12px; font-size:14px; }
    footer { margin-top: 16px; color: #94a3b8; font-size: 12px; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; background:#0b1220; border:1px solid #1f2937; padding:2px 6px; border-radius:6px; }
    .titlebar { display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:12px; }
    .pill { font-size:12px; padding:6px 10px; border:1px solid #334155; border-radius:999px; color:#a5b4fc; background: rgba(99,102,241,.08); }
    .success { border-left-color: var(--accent-2); }
    .danger { border-left-color: var(--danger); }

    /* === Body-map mannequin (segmentée) === */
    .bodymap { display:flex; align-items:center; gap:12px; margin-top:8px; }
    .bodymap .mapwrap {
      background:#0a0f1b; border:1px solid #192133; border-radius:12px;
      padding:10px; width:260px; min-width:260px;
    }
    .bodymap-hint { font-size:12px; color:var(--muted); }
    .bm-outline { fill:#0b1220; stroke:#1d2740; stroke-width:1.2; opacity:.55; }
    .bm-region {
      fill:#0b1220; stroke:#263043; stroke-width:1.5; cursor:pointer;
      transition:fill .15s ease, stroke .15s ease;
    }
    .bm-region:hover, .bm-region:focus { outline:none; fill:#111a2e; stroke:#7c89ff; }
    .bm-region.active { fill:rgba(99,102,241,.28); stroke:#8b5cf6; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Trauma Triage — Outil de <strong>pré</strong>-diagnostic</h1>
          <div class="pill" aria-live="polite">Diagnostique d'intervention rapide· Ne remplace pas un avis médical poussé à l'hopital</div>
        </div>
      </div>
      <div class="row">
        <button class="btn ghost" id="btn-export-json" title="Exporter le cas (JSON)">Exporter</button>
        <button class="btn ghost" id="btn-print" title="Imprimer / PDF">Imprimer</button>
      </div>
    </header>

    <div class="grid">
      <!-- Formulaire -->
      <section class="card" aria-labelledby="form-title">
        <div class="titlebar">
          <div class="section-title" id="form-title">Entrée patient RP</div>
          <div class="prio">Remplissez les champs puis cliquez <span class="kbd">Calculer</span></div>
        </div>

        <div class="row" style="gap:16px">
          <div style="flex:1 1 100%">
            <label for="incident">Que s'est-il passé ? (résumé court)</label>
            <textarea id="incident" rows="3" placeholder="Ex.: échange de tirs, impact cuisse G; saignement contrôlé"></textarea>
          </div>

          <div style="flex:1 1 220px; min-width: 220px;">
            <label for="location">Localisation principale de la douleur</label>

            <!-- ===== Body-map segmentée ===== -->
            <div class="bodymap" aria-label="Carte du corps cliquable">
              <div class="mapwrap">
                <svg viewBox="0 0 200 360" width="100%" role="img" aria-labelledby="bmTitle">
                  <title id="bmTitle">Body-map mannequin (face)</title>

                  <!-- Tête -->
                  <circle class="bm-region" tabindex="0" data-zone="head" cx="100" cy="38" r="22"><title>Tête / Crâne</title></circle>

                  <!-- Cou -->
                  <rect class="bm-region" tabindex="0" data-zone="neck" x="90" y="60" rx="4" ry="4" width="20" height="14"><title>Cou / Gorge</title></rect>

                  <!-- Thorax -->
                  <rect class="bm-region" tabindex="0" data-zone="chest" x="65" y="78" rx="10" ry="10" width="70" height="50"><title>Thorax / Poitrine</title></rect>

                  <!-- Abdomen -->
                  <rect class="bm-region" tabindex="0" data-zone="abdomen" x="70" y="132" rx="10" ry="10" width="60" height="36"><title>Abdomen / Ventre</title></rect>

                  <!-- Bassin -->
                  <rect class="bm-region" tabindex="0" data-zone="pelvis" x="72" y="172" rx="10" ry="10" width="56" height="28"><title>Bassin</title></rect>

                  <!-- BRAS GAUCHE : bras (haut) + avant-bras (bas) -->
                  <rect class="bm-region" tabindex="0" data-zone="upper_arm_left" x="38" y="82" rx="12" ry="12" width="22" height="40"><title>Bras gauche (humérus)</title></rect>
                  <rect class="bm-region" tabindex="0" data-zone="forearm_left" x="38" y="124" rx="12" ry="12" width="22" height="80"><title>Avant-bras gauche</title></rect>

                  <!-- BRAS DROIT -->
                  <rect class="bm-region" tabindex="0" data-zone="upper_arm_right" x="140" y="82" rx="12" ry="12" width="22" height="40"><title>Bras droit (humérus)</title></rect>
                  <rect class="bm-region" tabindex="0" data-zone="forearm_right" x="140" y="124" rx="12" ry="12" width="22" height="80"><title>Avant-bras droit</title></rect>

                  <!-- JAMBE GAUCHE : cuisse + jambe -->
                  <rect class="bm-region" tabindex="0" data-zone="thigh_left" x="78" y="204" rx="10" ry="10" width="20" height="68"><title>Cuisse gauche</title></rect>
                  <rect class="bm-region" tabindex="0" data-zone="leg_left" x="78" y="274" rx="10" ry="10" width="20" height="70"><title>Jambe gauche</title></rect>

                  <!-- JAMBE DROITE -->
                  <rect class="bm-region" tabindex="0" data-zone="thigh_right" x="102" y="204" rx="10" ry="10" width="20" height="68"><title>Cuisse droite</title></rect>
                  <rect class="bm-region" tabindex="0" data-zone="leg_right" x="102" y="274" rx="10" ry="10" width="20" height="70"><title>Jambe droite</title></rect>
                </svg>
                <div class="bodymap-hint">Clique une zone — le sélecteur se met à jour.</div>
              </div>

              <div style="flex:1">
                <select id="location">
                  <option value="head">Tête / Crâne</option>
                  <option value="neck">Cou / Gorge</option>
                  <option value="chest">Thorax / Poitrine</option>
                  <option value="abdomen">Abdomen / Ventre</option>
                  <option value="pelvis">Bassin</option>
                  <optgroup label="Bras gauche">
                    <option value="upper_arm_left">Bras (haut) — gauche</option>
                    <option value="forearm_left">Avant-bras — gauche</option>
                  </optgroup>
                  <optgroup label="Bras droit">
                    <option value="upper_arm_right">Bras (haut) — droit</option>
                    <option value="forearm_right">Avant-bras — droit</option>
                  </optgroup>
                  <optgroup label="Jambe gauche">
                    <option value="thigh_left">Cuisse — gauche</option>
                    <option value="leg_left">Jambe — gauche</option>
                  </optgroup>
                  <optgroup label="Jambe droite">
                    <option value="thigh_right">Cuisse — droit</option>
                    <option value="leg_right">Jambe — droit</option>
                  </optgroup>
                  <option value="back">Dos</option>
                  <option value="skin">Peau / Plaies</option>
                </select>
              </div>
            </div>
            <!-- ===== fin body-map ===== -->

          </div>

          <div style="flex:1 1 260px; min-width: 260px;">
            <label for="pain">Niveau de douleur (1–10)</label>
            <div class="range-wrap">
              <input id="pain" type="range" min="1" max="10" value="5" step="1" />
              <div style="display:flex; justify-content:space-between; margin-top:6px; font-size:12px; color:var(--muted)">
                <span>1</span><span>5</span><span>10</span>
              </div>
              <div id="pain-label" style="margin-top:6px; font-weight:600;">Sévérité: 5 — Modérée</div>
            </div>
          </div>
        </div>

        <!-- Champs complémentaires -->
        <div class="row" style="margin-top:10px; gap:12px">
          <div style="flex:1 1 160px; min-width:160px;">
            <label for="age">Âge</label>
            <input type="text" id="age" placeholder="ex. 28" />
          </div>
          <div style="flex:1 1 200px; min-width:200px;">
            <label for="delay">Délai depuis l'incident (heures)</label>
            <input type="text" id="delay" placeholder="ex. 3" />
          </div>
          <div style="flex:2 1 260px; min-width:260px;">
            <label>ATCD (cocher si présents)</label>
            <div class="row">
              <label class="chip"><input type="checkbox" id="hx-anticoag" /> Anticoagulants</label>
              <label class="chip"><input type="checkbox" id="hx-diabetes" /> Diabète</label>
              <label class="chip"><input type="checkbox" id="hx-immuno" /> Immunodépression</label>
            </div>
          </div>
        </div>

        <div style="margin-top:10px">
          <label>Signes visibles (cocher si présents)</label>
          <div class="row">
            <label class="chip"><input type="checkbox" id="f-bleeding" /> Saignement important</label>
            <label class="chip"><input type="checkbox" id="f-deformity" /> Déformation</label>
            <label class="chip"><input type="checkbox" id="f-loc" /> Perte de conscience / confusion</label>
            <!-- >>> NOUVEAU : Blessure par balle -->
            <label class="chip"><input type="checkbox" id="f-gsw" /> Blessure par balle </label>
          </div>
        </div>

        <div class="btns" style="margin-top:14px;">
          <button class="btn" id="btn-calc">Calculer</button>
          <button class="btn secondary" id="btn-reset" type="button">Réinitialiser</button>
        </div>
      </section>

      <!-- Résultats -->
      <section class="card" aria-labelledby="res-title">
        <div class="titlebar">
          <div class="section-title" id="res-title">Résultats (pré-diagnostic)</div>
          <div class="prio" id="meta-count">—</div>
        </div>
        <div id="results" class="results" aria-live="polite"></div>
        <div id="no-results" class="callout" style="display:none; margin-top:8px">Aucun résultat. Saisissez des informations puis cliquez <span class="kbd">Calculer</span>.</div>

        <!-- Bouton copier -->
        <button class="btn" id="btn-copy" style="margin-top:10px; width:100%">📋 Copier le résumé</button>
      </section>
    </div>

    <footer>
      <p>© <span id="year"></span> — Trauma Triage.</p>
    </footer>
  </div>

  <script>
    const els = {
      incident: document.getElementById('incident'),
      location: document.getElementById('location'),
      pain: document.getElementById('pain'),
      painLabel: document.getElementById('pain-label'),
      age: document.getElementById('age'),
      delay: document.getElementById('delay'),
      hxAnticoag: document.getElementById('hx-anticoag'),
      hxDiabetes: document.getElementById('hx-diabetes'),
      hxImmuno: document.getElementById('hx-immuno'),
      fBleeding: document.getElementById('f-bleeding'),
      fDeformity: document.getElementById('f-deformity'),
      fLoc: document.getElementById('f-loc'),
      fGSW: document.getElementById('f-gsw'),
      btnCalc: document.getElementById('btn-calc'),
      btnReset: document.getElementById('btn-reset'),
      btnExport: document.getElementById('btn-export-json'),
      btnPrint: document.getElementById('btn-print'),
      btnCopy: document.getElementById('btn-copy'),
      results: document.getElementById('results'),
      noResults: document.getElementById('no-results'),
      metaCount: document.getElementById('meta-count'),
    };

    // --- Body-map sync ---
    const mapRegions = () => Array.from(document.querySelectorAll('.bm-region'));
    function highlight(zone){ mapRegions().forEach(el=> el.classList.toggle('active', el.dataset.zone === zone)); }
    function setLocation(zone){ if(!zone) return; els.location.value = zone; highlight(zone); }
    mapRegions().forEach(el=>{
      el.addEventListener('click', ()=> setLocation(el.dataset.zone));
      el.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' ') { e.preventDefault(); setLocation(el.dataset.zone);} });
    });
    els.location.addEventListener('change', ()=> highlight(els.location.value));
    highlight(els.location.value);

    // Douleur
    function updatePainLabel() {
      const v = Number(els.pain.value);
      const band = v <= 3 ? 'Faible' : v <= 7 ? 'Modérée' : 'Sévère';
      els.painLabel.textContent = `Sévérité: ${v} — ${band}`;
    }
    els.pain.addEventListener('input', updatePainLabel);
    updatePainLabel();

    // Helpers zones détaillées
    const isUpperArm   = z => ['upper_arm_left','upper_arm_right'].includes(z);
    const isForearm    = z => ['forearm_left','forearm_right'].includes(z);
    const isThigh      = z => ['thigh_left','thigh_right'].includes(z);
    const isLeg        = z => ['leg_left','leg_right'].includes(z);
    const isUpperExt   = z => isUpperArm(z) || isForearm(z);
    const isLowerExt   = z => isThigh(z) || isLeg(z);

    // Moteur étendu (intègre GSW)
    function computePreDiagnosis({ location, pain, findings, age, delayHours, hx }) {
      const out = [];
      const p = Number(pain);

      // Red flags généraux
      if (findings.bleeding) out.push({ tag: 'Hémorragie active', priority: 1, advice: 'Compression/garrot, évacuation rapide.' });
      if (findings.lossOfConsciousness) out.push({ tag: 'Altération neurologique (TC suspect)', priority: 1, advice: 'Surveillance neuro, immobilisation tête/cou, évacuation.' });

      // >>> GSW : toujours P1 + hypothèse par zone
      if (findings.gsw) {
        out.push({ tag: 'Blessure par balle', priority: 1, advice: "Urgence vitale : contrôle hémorragie, pansement occlusif si thorax, évacuation immédiate pour chirurgie." });
        if (location === 'chest') {
          out.push({ tag: 'GSW thoracique — pneumo/hémothorax (suspect)', priority: 1, advice: 'Détresse respi possible : pansement occlusif 3 côtés, évacuation.' });
        } else if (location === 'abdomen' || location === 'pelvis') {
          out.push({ tag: 'GSW abdominal/pelvien — hémorragie interne (suspecte)', priority: 1, advice: 'Choc possible : transport rapide vers bloc.' });
        } else if (location === 'head' || location === 'neck') {
          out.push({ tag: 'GSW tête/cou — lésion critique', priority: 1, advice: 'Saignement : prioriser contrôle, évacuation immédiate.' });
        } else if (isUpperExt(location) || isLowerExt(location)) {
          out.push({ tag: 'GSW membre — lésion vasculo-nerveuse (suspecte)', priority: 1, advice: 'Garrot/pression, vérifier motricité/sensibilité distale, évacuation.' });
        }
      }

      // Tête / cou
      if (location === 'head' || location === 'neck') {
        if (p >= 8) out.push({ tag: 'Traumatisme crânien modéré/sévère', priority: 2, advice: 'Céphalées intenses, vomissements, troubles → évacuation.' });
        else if (p >= 4) out.push({ tag: 'Commotion / contusion', priority: 3, advice: 'Repos, glace, surveillance 24h.' });
        else out.push({ tag: 'Contusion légère', priority: 4, advice: 'Glace locale, repos, réévaluation.' });

        if (location === 'neck') {
          if (p >= 6 || findings.deformity) out.push({ tag: 'Entorse cervicale / lésion ligamentaire', priority: 2, advice: 'Minevre, éviter mobilisations, évacuation si signes neuro.' });
          else out.push({ tag: 'Cervicalgie mécanique', priority: 3, advice: 'Repos, chaleur douce, antalgiques.' });
        }
      }

      // Thorax
      if (location === 'chest') {
        if (p >= 8 || findings.deformity) {
          out.push({ tag: 'Fractures costales multiples / volet', priority: 1, advice: 'Détresse respi possible — évacuation urgente.' });
          out.push({ tag: 'Pneumothorax/contusion pulmonaire (suspect)', priority: 1, advice: 'Douleur latérale + dyspnée → évacuation.' });
        } else if (p >= 5) {
          out.push({ tag: 'Fracture costale isolée', priority: 2, advice: 'Analgésie, surveiller dyspnée/toux.' });
          out.push({ tag: 'Contusion costale', priority: 3, advice: 'Repos, glace, respiration contrôlée.' });
        } else {
          out.push({ tag: 'Douleur pariétale mineure', priority: 3, advice: 'Repos, surveillance.' });
        }
      }

      // Abdomen / bassin
      if (location === 'abdomen' || location === 'pelvis') {
        if (p >= 7 || findings.bleeding) out.push({ tag: 'Lésion viscérale / hémorragie interne (suspecte)', priority: 1, advice: 'Transport rapide, surveiller signes de choc.' });
        else if (p >= 4) out.push({ tag: 'Contusion abdominale', priority: 2, advice: 'Surveillance défense/rigidité; aggravation → évacuation.' });
        else out.push({ tag: 'Atteinte pariétale mineure', priority: 4, advice: 'Glace, repos, réévaluation.' });
        if (location === 'pelvis' && (p >= 6 || findings.deformity)) out.push({ tag: 'Atteinte pelvienne (suspecte)', priority: 1, advice: 'Douleur bassin/instabilité → évacuation.' });
      }

      // Membres supérieurs (détaillés)
      if (isUpperExt(location)) {
        if (isUpperArm(location)) {
          if (findings.deformity || p >= 8) out.push({ tag: 'Fracture humérus (suspecte)', priority: 2, advice: 'Immobiliser bras, coussin d’écharpe, évacuation pour imagerie.' });
          if (p >= 5 && !findings.deformity) out.push({ tag: 'Luxation épaule (possible)', priority: 2, advice: 'Déformation/impotence → immobiliser, évacuation.' });
          if (p >= 4) out.push({ tag: 'Contusion musculaire (deltoïde/biceps)', priority: 3, advice: 'R.I.C.E., antalgiques.' });
          if (p < 4) out.push({ tag: 'Douleur bénigne du bras', priority: 4, advice: 'Repos, glace, surveillance.' });
        }
        if (isForearm(location)) {
          if (findings.deformity || p >= 8) out.push({ tag: 'Fracture radius/ulna (avant-bras)', priority: 2, advice: 'Attelle, contrôle saignement, évacuation.' });
          else if (p >= 5) {
            out.push({ tag: 'Entorse poignet (possible)', priority: 3, advice: 'Contention, R.I.C.E.' });
            out.push({ tag: 'Fracture non déplacée (possible)', priority: 3, advice: 'Douleur osseuse à la palpation → imagerie.' });
          } else {
            out.push({ tag: 'Contusion avant-bras', priority: 4, advice: 'Glace, pansement si abrasion.' });
          }
          if (findings.bleeding) out.push({ tag: 'Plaie tendineuse (suspecte)', priority: 2, advice: 'Nettoyage, pansement compressif, évaluation suture.' });
        }
      }

      // Membres inférieurs (détaillés)
      if (isLowerExt(location)) {
        if (isThigh(location)) {
          if (findings.deformity || p >= 8) out.push({ tag: 'Fracture fémur (suspecte)', priority: 1, advice: 'Douleur intense, déformation → immobiliser, évacuation.' });
          if (p >= 5) out.push({ tag: 'Déchirure quadri/ischios (possible)', priority: 3, advice: 'R.I.C.E., éviter appui, réévaluation.' });
          if (p < 5) out.push({ tag: 'Contusion cuisse', priority: 4, advice: 'Glace/élévation.' });
        }
        if (isLeg(location)) {
          if (findings.deformity || p >= 8) out.push({ tag: 'Fracture tibia/péroné (suspecte)', priority: 2, advice: 'Attelle, contrôle saignement, évacuation.' });
          else if (p >= 5) {
            out.push({ tag: 'Entorse cheville sévère (possible)', priority: 3, advice: 'R.I.C.E., immobilisation.' });
            out.push({ tag: 'Fracture malléolaire non déplacée (possible)', priority: 3, advice: 'Douleur osseuse, imagerie.' });
          } else {
            out.push({ tag: 'Contusion jambe', priority: 4, advice: 'Glace, pansement si abrasion.' });
          }
        }
      }

      // Dos
      if (location === 'back') {
        if (p >= 7 || findings.deformity || findings.lossOfConsciousness) out.push({ tag: 'Atteinte rachidienne (suspecte)', priority: 1, advice: 'Immobiliser, éviter rotations, évacuation.' });
        else out.push({ tag: 'Lombalgie/contusion dorsale', priority: 3, advice: 'Repos, chaleur douce, antalgiques.' });
      }

      // Peau
      if (location === 'skin') {
        if (p >= 6 || findings.bleeding) out.push({ tag: 'Lacération / avulsion', priority: 2, advice: 'Nettoyage, compresser, suture selon taille.' });
        else out.push({ tag: 'Abrasions/éraflures', priority: 4, advice: 'Nettoyage doux, pansement.' });
      }

      if (!out.length) out.push({ tag: 'Évaluation non spécifique', priority: 4, advice: 'Surveillance, éviter activité, réévaluation.' });

      // Modificateurs généraux
      const clamp = (n, min, max) => Math.max(min, Math.min(max, n));
      const extremeAge = Number.isFinite(age) && (age < 18 || age > 65);
      const anticoag = !!(hx && hx.anticoagulants);
      const persist = (delayHours >= 24) && (p >= 6);

      for (const item of out) {
        let pr = item.priority;
        if (anticoag && (location === 'head' || location === 'neck' || findings.lossOfConsciousness)) pr = 1;
        if (extremeAge && pr > 1) pr -= 1;
        if (persist && pr > 1) pr -= 1;
        item.priority = clamp(pr, 1, 4);
      }

      out.sort((a, b) => a.priority - b.priority);
      return out;
    }

    function renderResults(list) {
      els.results.innerHTML = '';
      if (!list || !list.length) { els.noResults.style.display = 'block'; els.metaCount.textContent = '—'; return; }
      els.noResults.style.display = 'none';
      els.metaCount.textContent = `${list.length} hypothèse(s)`;
      for (const item of list) {
        const div = document.createElement('div');
        div.className = 'result ' + (item.priority === 1 ? 'danger' : item.priority === 2 ? 'success' : '');
        div.innerHTML = `
          <div class="tag">${item.tag}</div>
          <div class="advice">${item.advice}</div>
          <div class="prio">Priorité: ${item.priority}</div>
        `;
        els.results.appendChild(div);
      }
    }

    function getFormValues() {
      const age = parseInt(els.age.value, 10);
      const delayHours = parseInt(els.delay.value, 10);
      return {
        incident: els.incident.value.trim(),
        location: els.location.value,
        pain: Number(els.pain.value),
        age: Number.isFinite(age) ? age : undefined,
        delayHours: Number.isFinite(delayHours) ? delayHours : 0,
        hx: {
          anticoagulants: !!els.hxAnticoag.checked,
          diabetes: !!els.hxDiabetes.checked,
          immunodepression: !!els.hxImmuno.checked,
        },
        findings: {
          bleeding: els.fBleeding.checked,
          deformity: els.fDeformity.checked,
          lossOfConsciousness: els.fLoc.checked,
          gsw: els.fGSW.checked,
        }
      };
    }

    function calculate(e) { e && e.preventDefault(); renderResults(computePreDiagnosis(getFormValues())); }

    function resetForm() {
      els.incident.value = '';
      els.location.value = 'head';
      els.pain.value = 5; updatePainLabel();
      els.age.value = ''; els.delay.value = '';
      els.hxAnticoag.checked = false; els.hxDiabetes.checked = false; els.hxImmuno.checked = false;
      els.fBleeding.checked = false; els.fDeformity.checked = false; els.fLoc.checked = false; els.fGSW.checked = false;
      els.results.innerHTML = ''; els.noResults.style.display = 'block'; els.metaCount.textContent = '—';
      highlight(els.location.value);
    }

    function exportJSON() {
      const data = {
        ...getFormValues(),
        results: Array.from(els.results.querySelectorAll('.result')).map(div => ({
          tag: div.querySelector('.tag')?.textContent || '',
          priority: Number((div.querySelector('.prio')?.textContent || '').replace(/[^0-9]/g,'')),
        })),
        timestamp: new Date().toISOString()
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `triage_case_${Date.now()}.json`;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    function copySummary() {
      const v = getFormValues();
      const resCards = els.results.querySelectorAll('.result');
      let txt = `Résumé rapide d'intervention\n`;
      txt += `Incident: ${v.incident || '—'}\n`;
      txt += `Zone: ${v.location}\nDouleur: ${v.pain}/10\n`;
      if (v.age !== undefined) txt += `Âge: ${v.age}\n`;
      if (v.delayHours) txt += `Délai: ${v.delayHours}h\n`;
      const atcd = [];
      if (v.hx.anticoagulants) atcd.push('anticoagulants');
      if (v.hx.diabetes) atcd.push('diabète');
      if (v.hx.immunodepression) atcd.push('immunodépression');
      if (atcd.length) txt += `ATCD: ${atcd.join(', ')}\n`;
      if (v.findings.gsw) txt += `Signes: blessure par balle\n`;
      if (v.findings.bleeding) txt += `Signes: saignement important\n`;
      if (v.findings.deformity) txt += `Signes: déformation\n`;
      if (v.findings.lossOfConsciousness) txt += `Signes: perte de conscience/confusion\n`;
      if (resCards.length) {
        txt += `Résultats:\n`;
        resCards.forEach(card => {
          const t = card.querySelector('.tag')?.textContent || '';
          const p = card.querySelector('.prio')?.textContent.replace(/[^0-9]/g,'') || '';
          const a = card.querySelector('.advice')?.textContent || '';
          txt += ` - ${t} (P${p}) — ${a}\n`;
        });
      } else { txt += `Résultats: —\n`; }
      navigator.clipboard.writeText(txt).then(() => {
        const old = els.btnCopy.textContent;
        els.btnCopy.textContent = '✔ Résumé copié';
        setTimeout(() => els.btnCopy.textContent = old, 1200);
      });
    }

    document.getElementById('year').textContent = new Date().getFullYear();
    els.btnCalc.addEventListener('click', calculate);
    els.btnReset.addEventListener('click', resetForm);
    els.btnExport.addEventListener('click', exportJSON);
    els.btnPrint.addEventListener('click', () => window.print());
    els.btnCopy.addEventListener('click', copySummary);

    // Initial
    resetForm();
  </script>
</body>
</html>


