<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GTA-RP Trauma Triage ‚Äî Pr√©-diagnostic</title>
  <style>
    :root {
      --bg: #0f172a; /* slate-900 */
      --card: #0b1220; /* darker */
      --text: #e2e8f0; /* slate-200 */
      --muted: #94a3b8; /* slate-400 */
      --accent: #6366f1; /* indigo-500 */
      --accent-2: #22c55e; /* green-500 */
      --warn: #f59e0b; /* amber-500 */
      --danger: #ef4444; /* red-500 */
      --border: #1f2937; /* gray-800 */
      --chip: #111827; /* gray-900 */
    }
    * { box-sizing: border-box; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 600px at 20% -10%, #1e293b 0, #0b1020 60%, #060913 100%);
      color: var(--text);
    }
    .container { max-width: 980px; margin: 40px auto; padding: 0 16px; }
    header { display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:20px; }
    .brand { display:flex; align-items:center; gap:12px; }
    .logo { width:40px; height:40px; border-radius:12px; background: linear-gradient(135deg, var(--accent), #8b5cf6); box-shadow: 0 10px 25px rgba(99,102,241,.35); }
    h1 { font-size: clamp(22px, 3vw, 28px); margin:0; letter-spacing: .2px; }
    .card { background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015)); border:1px solid var(--border); border-radius: 18px; padding: 18px; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
    .grid { display:grid; grid-template-columns: 1fr; gap: 16px; }
    @media (min-width: 900px) { .grid { grid-template-columns: 1.1fr .9fr; } }
    label { font-size: 14px; color: var(--muted); display:block; margin-bottom:6px; }
    textarea, select, input[type="text"] { width:100%; background:#0a0f1b; color:var(--text); border:1px solid #192133; padding:10px 12px; border-radius:12px; outline:none; }
    textarea:focus, select:focus, input[type="text"]:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(99,102,241,.25); }
    .range-wrap { background:#0a0f1b; border:1px solid #192133; padding:12px; border-radius:12px; }
    input[type="range"] { width:100%; }
    .row { display:flex; flex-wrap:wrap; gap:12px; }
    .chip { display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:12px; background: var(--chip); border:1px solid #1f2937; font-size: 14px; }
    .btns { display:flex; gap:10px; flex-wrap:wrap; }
    .btn { background: var(--accent); color:white; border:none; padding:10px 14px; border-radius:14px; cursor:pointer; font-weight:600; letter-spacing:.2px; }
    .btn.secondary { background:transparent; border:1px solid #334155; color: var(--text); }
    .btn.ghost { background:transparent; color: var(--muted); }
    .section-title { font-size:18px; font-weight:700; margin: 6px 0 10px; }
    .results { display:grid; gap:12px; }
    .result { border:1px solid #1f2937; border-left:4px solid var(--accent); padding:12px; border-radius:12px; background:#0a0f1b; }
    .prio { font-size:12px; color:#cbd5e1; opacity:.9; }
    .tag { font-weight:700; }
    .advice { color:#cbd5e1; margin-top:4px; }
    .callout { background: rgba(245, 158, 11, .1); border:1px solid rgba(245, 158, 11, .35); color:#fde68a; border-radius:12px; padding:10px 12px; font-size:14px; }
    footer { margin-top: 16px; color: #94a3b8; font-size: 12px; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; background:#0b1220; border:1px solid #1f2937; padding:2px 6px; border-radius:6px; }
    .titlebar { display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:12px; }
    .pill { font-size:12px; padding:6px 10px; border:1px solid #334155; border-radius:999px; color:#a5b4fc; background: rgba(99,102,241,.08); }
    .success { border-left-color: var(--accent-2); }
    .danger { border-left-color: var(--danger); }

    /* === Body-map am√©lior√©e === */
    .bodymap { display:flex; align-items:center; gap:12px; margin-top:8px; }
    .bodymap .mapwrap {
      background:#0a0f1b; border:1px solid #192133; border-radius:12px;
      padding:8px; width:240px; min-width:240px;
    }
    .bodymap-hint { font-size:12px; color:var(--muted); }
    .bm-silhouette { fill:#0b1220; stroke:#1d2740; stroke-width:1.2; opacity:.7; }
    .bm-region {
      fill:transparent; stroke:#263043; stroke-width:1.5; cursor:pointer;
      transition:fill .15s ease, stroke .15s ease, opacity .15s ease;
    }
    .bm-region:hover, .bm-region:focus { outline:none; fill:rgba(99,102,241,.12); stroke:#7c89ff; }
    .bm-region.active { fill:rgba(99,102,241,.25); stroke:#8b5cf6; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Trauma Triage ‚Äî Outil de <strong>pr√©</strong>-diagnostic</h1>
          <div class="pill" aria-live="polite">Diagnostique d'intervention rapide¬∑ Ne remplace pas un avis m√©dical pouss√© √† l'hopital</div>
        </div>
      </div>
      <div class="row">
        <button class="btn ghost" id="btn-export-json" title="Exporter le cas (JSON)">Exporter</button>
        <button class="btn ghost" id="btn-print" title="Imprimer / PDF">Imprimer</button>
      </div>
    </header>

    <div class="grid">
      <!-- Formulaire -->
      <section class="card" aria-labelledby="form-title">
        <div class="titlebar">
          <div class="section-title" id="form-title">Entr√©e patient RP</div>
          <div class="prio">Remplissez les champs puis cliquez <span class="kbd">Calculer</span></div>
        </div>

        <div class="row" style="gap:16px">
          <div style="flex:1 1 100%">
            <label for="incident">Que s'est-il pass√© ? (r√©sum√© court)</label>
            <textarea id="incident" rows="3" placeholder="Ex.: chute de moto √† 80 km/h, impact t√™te/√©paule, casque port√©"></textarea>
          </div>

          <div style="flex:1 1 220px; min-width: 220px;">
            <label for="location">Localisation principale de la douleur</label>

            <!-- ===== Body-map silhouette (synchronis√©e) ===== -->
            <div class="bodymap" aria-label="Carte du corps cliquable">
              <div class="mapwrap">
                <svg viewBox="0 0 180 360" width="100%" role="img" aria-labelledby="bmTitle">
                  <title id="bmTitle">Body-map simplifi√©e</title>

                  <!-- Silhouette d'arri√®re-plan (non cliquable) -->
                  <path class="bm-silhouette" d="
                    M90,18
                    c14,0 26,11 26,24
                    c0,10 -7,18 -9,24
                    c14,6 24,18 28,32
                    c3,10 3,21 3,31
                    v16
                    c10,6 18,14 22,24
                    c4,8 6,18 6,27
                    v14
                    c0,8 -2,16 -6,23
                    c-8,12 -19,22 -31,28
                    v36
                    c0,6 -4,10 -10,10
                    h-8
                    c-6,0 -10,-4 -10,-10
                    v-32
                    h-6
                    v32
                    c0,6 -4,10 -10,10
                    h-8
                    c-6,0 -10,-4 -10,-10
                    v-36
                    c-12,-6 -23,-16 -31,-28
                    c-4,-7 -6,-15 -6,-23
                    v-14
                    c0,-9 2,-19 6,-27
                    c4,-10 12,-18 22,-24
                    v-16
                    c0,-10 0,-21 3,-31
                    c4,-14 14,-26 28,-32
                    c-2,-6 -9,-14 -9,-24
                    c0,-13 12,-24 26,-24 z
                  " />

                  <!-- Zones cliquables (paths plus organiques) -->
                  <!-- T√™te -->
                  <path class="bm-region" tabindex="0" data-zone="head" d="
                    M90,18
                    c14,0 26,11 26,24
                    c0,12 -12,22 -26,22
                    c-14,0 -26,-10 -26,-22
                    c0,-13 12,-24 26,-24 z
                  ">
                    <title>T√™te / Cr√¢ne</title>
                  </path>

                  <!-- Cou -->
                  <path class="bm-region" tabindex="0" data-zone="neck" d="
                    M74,64
                    c5,4 11,6 16,6
                    c5,0 11,-2 16,-6
                    v10
                    c-5,4 -11,6 -16,6
                    c-5,0 -11,-2 -16,-6 z
                  ">
                    <title>Cou / Gorge</title>
                  </path>

                  <!-- Thorax -->
                  <path class="bm-region" tabindex="0" data-zone="chest" d="
                    M62,82
                    c10,-6 20,-8 28,-8
                    c8,0 18,2 28,8
                    c6,4 10,10 12,17
                    c2,7 2,14 2,22
                    c-22,10 -60,10 -72,0
                    c0,-8 0,-15 2,-22
                    c2,-7 6,-13 12,-17 z
                  ">
                    <title>Thorax / Poitrine</title>
                  </path>

                  <!-- Dos (zone post√©rieure approxim√©e, on l'autorise ici aussi) -->
                  <path class="bm-region" tabindex="0" data-zone="back" d="
                    M52,90
                    c-6,6 -10,14 -12,22
                    c-2,9 -2,18 -2,27
                    c18,10 88,10 106,0
                    c0,-9 0,-18 -2,-27
                    c-2,-8 -6,-16 -12,-22
                    c-14,8 -28,12 -39,12
                    c-11,0 -25,-4 -39,-12 z
                  ">
                    <title>Dos</title>
                  </path>

                  <!-- Abdomen -->
                  <path class="bm-region" tabindex="0" data-zone="abdomen" d="
                    M66,130
                    c8,6 16,8 24,8
                    c8,0 16,-2 24,-8
                    c2,10 2,19 2,28
                    c-18,8 -36,8 -52,0
                    c0,-9 0,-18 2,-28 z
                  ">
                    <title>Abdomen / Ventre</title>
                  </path>

                  <!-- Bassin -->
                  <path class="bm-region" tabindex="0" data-zone="pelvis" d="
                    M64,162
                    c9,6 17,8 26,8
                    c9,0 17,-2 26,-8
                    c3,6 5,12 6,18
                    c-26,10 -38,10 -64,0
                    c1,-6 3,-12 6,-18 z
                  ">
                    <title>Bassin</title>
                  </path>

                  <!-- Membres sup√©rieurs (gauche/droite) -->
                  <path class="bm-region" tabindex="0" data-zone="upper_ext" d="
                    M38,92
                    c-8,6 -14,14 -18,24
                    c-4,10 -6,22 -6,33
                    c0,8 2,16 6,22
                    c4,6 10,10 16,12
                    c4,-8 6,-18 6,-30
                    c0,-18 -2,-38 -4,-61 z
                  ">
                    <title>Membres sup√©rieurs</title>
                  </path>
                  <path class="bm-region" tabindex="0" data-zone="upper_ext" d="
                    M142,92
                    c8,6 14,14 18,24
                    c4,10 6,22 6,33
                    c0,8 -2,16 -6,22
                    c-4,6 -10,10 -16,12
                    c-4,-8 -6,-18 -6,-30
                    c0,-18 2,-38 4,-61 z
                  ">
                    <title>Membres sup√©rieurs</title>
                  </path>

                  <!-- Membres inf√©rieurs (cuisses/jambes/pieds simplifi√©s) -->
                  <path class="bm-region" tabindex="0" data-zone="lower_ext" d="
                    M72,188
                    c-2,10 -4,22 -4,36
                    c0,10 2,20 4,30
                    c2,8 4,16 4,24
                    c0,8 -2,16 -6,22
                    h-10
                    c-6,-10 -10,-22 -12,-36
                    c-2,-20 0,-40 6,-58
                    c4,-10 10,-16 18,-18 z
                  ">
                    <title>Membres inf√©rieurs</title>
                  </path>
                  <path class="bm-region" tabindex="0" data-zone="lower_ext" d="
                    M108,188
                    c2,10 4,22 4,36
                    c0,10 -2,20 -4,30
                    c-2,8 -4,16 -4,24
                    c0,8 2,16 6,22
                    h10
                    c6,-10 10,-22 12,-36
                    c2,-20 0,-40 -6,-58
                    c-4,-10 -10,-16 -18,-18 z
                  ">
                    <title>Membres inf√©rieurs</title>
                  </path>

                </svg>
                <div class="bodymap-hint">Clique une zone ‚Äî le s√©lecteur se met √† jour.</div>
              </div>

              <div style="flex:1">
                <select id="location">
                  <option value="head">T√™te / Cr√¢ne</option>
                  <option value="neck">Cou / Gorge</option>
                  <option value="chest">Thorax / Poitrine</option>
                  <option value="abdomen">Abdomen / Ventre</option>
                  <option value="pelvis">Bassin</option>
                  <option value="upper_ext">Membres sup√©rieurs</option>
                  <option value="lower_ext">Membres inf√©rieurs</option>
                  <option value="back">Dos</option>
                  <option value="skin">Peau / Plaies</option>
                </select>
              </div>
            </div>
            <!-- ===== fin body-map ===== -->

          </div>

          <div style="flex:1 1 260px; min-width: 260px;">
            <label for="pain">Niveau de douleur (1‚Äì10)</label>
            <div class="range-wrap">
              <input id="pain" type="range" min="1" max="10" value="5" step="1" />
              <div style="display:flex; justify-content:space-between; margin-top:6px; font-size:12px; color:var(--muted)">
                <span>1</span><span>5</span><span>10</span>
              </div>
              <div id="pain-label" style="margin-top:6px; font-weight:600;">S√©v√©rit√©: 5 ‚Äî Mod√©r√©e</div>
            </div>
          </div>
        </div>

        <!-- Champs compl√©mentaires -->
        <div class="row" style="margin-top:10px; gap:12px">
          <div style="flex:1 1 160px; min-width:160px;">
            <label for="age">√Çge</label>
            <input type="text" id="age" placeholder="ex. 28" />
          </div>
          <div style="flex:1 1 200px; min-width:200px;">
            <label for="delay">D√©lai depuis l'incident (heures)</label>
            <input type="text" id="delay" placeholder="ex. 3" />
          </div>
          <div style="flex:2 1 260px; min-width:260px;">
            <label>ATCD (cocher si pr√©sents)</label>
            <div class="row">
              <label class="chip"><input type="checkbox" id="hx-anticoag" /> Anticoagulants/AA</label>
              <label class="chip"><input type="checkbox" id="hx-diabetes" /> Diab√®te</label>
              <label class="chip"><input type="checkbox" id="hx-immuno" /> Immunod√©pression</label>
            </div>
          </div>
        </div>

        <div style="margin-top:10px">
          <label>Signes visibles (cocher si pr√©sents)</label>
          <div class="row">
            <label class="chip"><input type="checkbox" id="f-bleeding" /> Saignement important</label>
            <label class="chip"><input type="checkbox" id="f-deformity" /> D√©formation</label>
            <label class="chip"><input type="checkbox" id="f-loc" /> Perte de conscience / confusion</label>
          </div>
        </div>

        <div class="btns" style="margin-top:14px">
          <button class="btn" id="btn-calc">Calculer</button>
          <button class="btn secondary" id="btn-reset" type="button">R√©initialiser</button>
        </div>
      </section>

      <!-- R√©sultats -->
      <section class="card" aria-labelledby="res-title">
        <div class="titlebar">
          <div class="section-title" id="res-title">R√©sultats (pr√©-diagnostic)</div>
          <div class="prio" id="meta-count">‚Äî</div>
        </div>
        <div id="results" class="results" aria-live="polite"></div>
        <div id="no-results" class="callout" style="display:none; margin-top:8px">Aucun r√©sultat. Saisissez des informations puis cliquez <span class="kbd">Calculer</span>.</div>

        <!-- Bouton copier -->
        <button class="btn" id="btn-copy" style="margin-top:10px; width:100%">üìã Copier le r√©sum√©</button>
      </section>
    </div>

    <footer>
      <p>¬© <span id="year"></span> ‚Äî Trauma Triage.</p>
    </footer>
  </div>

  <script>
    const els = {
      incident: document.getElementById('incident'),
      location: document.getElementById('location'),
      pain: document.getElementById('pain'),
      painLabel: document.getElementById('pain-label'),
      age: document.getElementById('age'),
      delay: document.getElementById('delay'),
      hxAnticoag: document.getElementById('hx-anticoag'),
      hxDiabetes: document.getElementById('hx-diabetes'),
      hxImmuno: document.getElementById('hx-immuno'),
      fBleeding: document.getElementById('f-bleeding'),
      fDeformity: document.getElementById('f-deformity'),
      fLoc: document.getElementById('f-loc'),
      btnCalc: document.getElementById('btn-calc'),
      btnReset: document.getElementById('btn-reset'),
      btnExport: document.getElementById('btn-export-json'),
      btnPrint: document.getElementById('btn-print'),
      btnCopy: document.getElementById('btn-copy'),
      results: document.getElementById('results'),
      noResults: document.getElementById('no-results'),
      metaCount: document.getElementById('meta-count'),
    };

    // --- Body-map sync ---
    const mapRegions = () => Array.from(document.querySelectorAll('.bm-region'));
    function highlight(zone){ mapRegions().forEach(el=> el.classList.toggle('active', el.dataset.zone === zone)); }
    function setLocation(zone){ if(!zone) return; els.location.value = zone; highlight(zone); }
    mapRegions().forEach(el=>{
      el.addEventListener('click', ()=> setLocation(el.dataset.zone));
      el.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' ') { e.preventDefault(); setLocation(el.dataset.zone);} });
    });
    els.location.addEventListener('change', ()=> highlight(els.location.value));
    highlight(els.location.value);

    // Douleur
    function updatePainLabel() {
      const v = Number(els.pain.value);
      const band = v <= 3 ? 'Faible' : v <= 7 ? 'Mod√©r√©e' : 'S√©v√®re';
      els.painLabel.textContent = `S√©v√©rit√©: ${v} ‚Äî ${band}`;
    }
    els.pain.addEventListener('input', updatePainLabel);
    updatePainLabel();

    // Moteur (inchang√©)
    function computePreDiagnosis({ location, pain, findings, age, delayHours, hx }) {
      const out = [];
      const painSeverity = Number(pain);

      if (findings.bleeding) out.push({ tag: 'H√©morragie', priority: 1, advice: 'Comprimer la plaie, pansement compressif, √©vacuation rapide.' });
      if (findings.lossOfConsciousness) out.push({ tag: 'Traumatisme cr√¢nien suspect', priority: 1, advice: "Surveillance neurologique, immobilisation t√™te/cou si m√©canisme violent, √©vacuation." });

      if (location === 'head' || location === 'neck') {
        if (painSeverity >= 8) out.push({ tag: 'Traumatisme cr√¢nien mod√©r√©/s√©v√®re', priority: 2, advice: 'C√©phal√©es intenses, vomissements, troubles -> √©vacuer.' });
        else if (painSeverity >= 4) out.push({ tag: 'Commotion / contusion', priority: 3, advice: 'Repos, glace, surveillance 24h RP.' });
        else out.push({ tag: 'Contusion l√©g√®re', priority: 4, advice: 'Glace locale, repos, r√©√©valuer.' });
      }

      if (location === 'chest') {
        if (painSeverity >= 8 || findings.deformity) out.push({ tag: 'Blessure thoracique grave (pneumothorax/contusion costale)', priority: 1, advice: 'D√©tresse respi possible ‚Äî position demi-assise, √©vacuation urgente.' });
        else if (painSeverity >= 5) out.push({ tag: 'Fracture costale ou contusion', priority: 2, advice: 'Immobiliser si possible, analg√©sie RP, surveiller dyspn√©e.' });
        else out.push({ tag: 'Douleur thoracique mineure', priority: 3, advice: 'Repos et surveillance.' });
      }

      if (location === 'abdomen' || location === 'pelvis') {
        if (painSeverity >= 7 || findings.bleeding) out.push({ tag: "H√©morragie interne / l√©sion visc√©rale (suspect√©e)", priority: 1, advice: "Transport rapide, surveiller signes de choc (p√¢leur, sueurs)." });
        else if (painSeverity >= 4) out.push({ tag: 'Contusion abdominale', priority: 2, advice: 'Surveillance douleur, d√©fense/rigidit√© -> √©vacuation RP.' });
        else out.push({ tag: 'Douleur abdominale mineure', priority: 4, advice: 'Repos, hydratation, r√©√©valuation.' });
      }

      if (location === 'upper_ext' || location === 'lower_ext') {
        if (findings.deformity || painSeverity >= 8) out.push({ tag: 'Fracture possible', priority: 2, advice: 'Immobiliser (attelle), contr√¥ler saignement, √©vacuation pour imagerie (RP).' });
        else if (painSeverity >= 5) out.push({ tag: 'Entorse / contusion s√©v√®re', priority: 3, advice: 'RICE (Repos, Ice, Compression, √âl√©vation).' });
        else out.push({ tag: 'Contusion / √©raflure', priority: 4, advice: 'Nettoyage, pansement, surveillance.' });
      }

      if (location === 'back') {
        if (painSeverity >= 7 || findings.deformity || findings.lossOfConsciousness) out.push({ tag: 'L√©sion rachidienne suspecte', priority: 1, advice: 'Immobiliser colonne, ne pas mobiliser, √©vacuation.' });
        else out.push({ tag: 'Douleur dorsale / contusion', priority: 3, advice: 'Repos, chaleur douce, r√©√©valuation.' });
      }

      if (location === 'skin') {
        if (painSeverity >= 6 || findings.bleeding) out.push({ tag: 'Plaie ouverte / lac√©ration', priority: 2, advice: 'Nettoyer (RP), compresser, envisager suture (RP) selon taille.' });
        else out.push({ tag: '√âgratignure / abrasion', priority: 4, advice: 'Nettoyage doux et pansement.' });
      }

      if (!out.length) out.push({ tag: '√âvaluation non sp√©cifique', priority: 4, advice: 'Surveillance, √©viter activit√©, r√©√©valuation.' });

      const clamp = (n, min, max) => Math.max(min, Math.min(max, n));
      const extremeAge = Number.isFinite(age) && (age < 18 || age > 65);
      const anticoag = !!(hx && hx.anticoagulants);
      const severePainPersist = (delayHours >= 24) && (painSeverity >= 6);

      for (const item of out) {
        let p = item.priority;
        if (anticoag && (location === 'head' || location === 'neck' || findings.lossOfConsciousness)) p = 1;
        if (extremeAge && p > 1) p -= 1;
        if (severePainPersist && p > 1) p -= 1;
        item.priority = clamp(p, 1, 4);
      }

      out.sort((a, b) => a.priority - b.priority);
      return out;
    }

    function renderResults(list) {
      els.results.innerHTML = '';
      if (!list || !list.length) { els.noResults.style.display = 'block'; els.metaCount.textContent = '‚Äî'; return; }
      els.noResults.style.display = 'none';
      els.metaCount.textContent = `${list.length} hypoth√®se(s)`;
      for (const item of list) {
        const div = document.createElement('div');
        div.className = 'result ' + (item.priority === 1 ? 'danger' : item.priority === 2 ? 'success' : '');
        div.innerHTML = `
          <div class="tag">${item.tag}</div>
          <div class="advice">${item.advice}</div>
          <div class="prio">Priorit√©: ${item.priority}</div>
        `;
        els.results.appendChild(div);
      }
    }

    function getFormValues() {
      const age = parseInt(els.age.value, 10);
      const delayHours = parseInt(els.delay.value, 10);
      return {
        incident: els.incident.value.trim(),
        location: els.location.value,
        pain: Number(els.pain.value),
        age: Number.isFinite(age) ? age : undefined,
        delayHours: Number.isFinite(delayHours) ? delayHours : 0,
        hx: {
          anticoagulants: !!els.hxAnticoag.checked,
          diabetes: !!els.hxDiabetes.checked,
          immunodepression: !!els.hxImmuno.checked,
        },
        findings: {
          bleeding: els.fBleeding.checked,
          deformity: els.fDeformity.checked,
          lossOfConsciousness: els.fLoc.checked,
        }
      };
    }

    function calculate(e) {
      e && e.preventDefault();
      renderResults(computePreDiagnosis(getFormValues()));
    }

    function resetForm() {
      els.incident.value = '';
      els.location.value = 'head';
      els.pain.value = 5; updatePainLabel();
      els.age.value = ''; els.delay.value = '';
      els.hxAnticoag.checked = false; els.hxDiabetes.checked = false; els.hxImmuno.checked = false;
      els.fBleeding.checked = false; els.fDeformity.checked = false; els.fLoc.checked = false;
      els.results.innerHTML = ''; els.noResults.style.display = 'block'; els.metaCount.textContent = '‚Äî';
      highlight(els.location.value);
    }

    function exportJSON() {
      const data = {
        ...getFormValues(),
        results: Array.from(els.results.querySelectorAll('.result')).map(div => ({
          tag: div.querySelector('.tag')?.textContent || '',
          priority: Number((div.querySelector('.prio')?.textContent || '').replace(/[^0-9]/g,'')),
        })),
        timestamp: new Date().toISOString()
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `triage_case_${Date.now()}.json`;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    function copySummary() {
      const v = getFormValues();
      const resCards = els.results.querySelectorAll('.result');
      let txt = `R√©sum√© RP ‚Äî Trauma Triage\n`;
      txt += `Incident: ${v.incident || '‚Äî'}\n`;
      txt += `Zone: ${v.location}\nDouleur: ${v.pain}/10\n`;
      if (v.age !== undefined) txt += `√Çge: ${v.age}\n`;
      if (v.delayHours) txt += `D√©lai: ${v.delayHours}h\n`;
      const atcd = [];
      if (v.hx.anticoagulants) atcd.push('anticoagulants/AA');
      if (v.hx.diabetes) atcd.push('diab√®te');
      if (v.hx.immunodepression) atcd.push('immunod√©pression');
      if (atcd.length) txt += `ATCD: ${atcd.join(', ')}\n`;
      if (resCards.length) {
        txt += `R√©sultats:\n`;
        resCards.forEach(card => {
          const t = card.querySelector('.tag')?.textContent || '';
          const p = card.querySelector('.prio')?.textContent.replace(/[^0-9]/g,'') || '';
          const a = card.querySelector('.advice')?.textContent || '';
          txt += ` - ${t} (P${p}) ‚Äî ${a}\n`;
        });
      } else { txt += `R√©sultats: ‚Äî\n`; }
      navigator.clipboard.writeText(txt).then(() => {
        const old = els.btnCopy.textContent;
        els.btnCopy.textContent = '‚úî R√©sum√© copi√©';
        setTimeout(() => els.btnCopy.textContent = old, 1200);
      });
    }

    document.getElementById('year').textContent = new Date().getFullYear();
    els.btnCalc.addEventListener('click', calculate);
    els.btnReset.addEventListener('click', resetForm);
    els.btnExport.addEventListener('click', exportJSON);
    els.btnPrint.addEventListener('click', () => window.print());
    els.btnCopy.addEventListener('click', copySummary);

    // Initial
    resetForm();
  </script>
</body>
</html>
